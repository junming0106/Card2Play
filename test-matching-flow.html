<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配對流程測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .result { 
            background: #f5f5f5; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1976d2; }
        .step { margin: 20px 0; padding: 15px; border: 2px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>配對流程測試</h1>
        
        <div class="step">
            <h3>步驟 1: 模擬正常配對</h3>
            <button onclick="performMatching()">進行配對 (matching-pg)</button>
            <div id="matching-result"></div>
        </div>
        
        <div class="step">
            <h3>步驟 2: 模擬離開後重新進入（狀態檢查）</h3>
            <button onclick="checkStatus()">檢查狀態 (matching-pg?status_only=true)</button>
            <div id="status-result"></div>
        </div>
        
        <div class="step">
            <h3>步驟 3: 直接測試 canUserMatch 函數</h3>
            <button onclick="testCanUserMatch()">測試 canUserMatch</button>
            <div id="canusermatch-result"></div>
        </div>
        
        <div class="step">
            <h3>步驟 4: 檢查資料庫狀態</h3>
            <button onclick="checkDatabase()">檢查資料庫</button>
            <div id="database-result"></div>
        </div>
        
        <div class="step">
            <button onclick="clearResults()">清除所有結果</button>
        </div>
    </div>

    <script>
        function showResult(elementId, title, data, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h4>${title}</h4>${JSON.stringify(data, null, 2)}`;
            element.appendChild(div);
        }

        function clearResults() {
            const resultElements = ['matching-result', 'status-result', 'canusermatch-result', 'database-result'];
            resultElements.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        // 步驟1: 正常配對
        async function performMatching() {
            try {
                showResult('matching-result', '執行中...', { status: 'loading' }, 'info');
                
                // 這裡需要實際的用戶 token，我們用 debug API 來模擬
                const response = await fetch('/api/debug/query-db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: 'SELECT * FROM user_matching_sessions WHERE user_id = 38'
                    })
                });
                
                const data = await response.json();
                showResult('matching-result', '當前配對會話狀態', data);
                
            } catch (error) {
                showResult('matching-result', '錯誤', { error: error.message }, 'error');
            }
        }

        // 步驟2: 狀態檢查
        async function checkStatus() {
            try {
                showResult('status-result', '執行中...', { status: 'loading' }, 'info');
                
                // 模擬狀態檢查，使用 debug API
                const response = await fetch('/api/debug/test-matching-status?userId=38');
                const data = await response.json();
                
                showResult('status-result', '配對狀態檢查結果', data);
                
            } catch (error) {
                showResult('status-result', '錯誤', { error: error.message }, 'error');
            }
        }

        // 步驟3: 測試 canUserMatch
        async function testCanUserMatch() {
            try {
                showResult('canusermatch-result', '執行中...', { status: 'loading' }, 'info');
                
                const response = await fetch('/api/debug/test-matching-status?userId=38');
                const data = await response.json();
                
                showResult('canusermatch-result', 'canUserMatch 函數測試結果', data);
                
            } catch (error) {
                showResult('canusermatch-result', '錯誤', { error: error.message }, 'error');
            }
        }

        // 步驟4: 檢查資料庫
        async function checkDatabase() {
            try {
                showResult('database-result', '執行中...', { status: 'loading' }, 'info');
                
                const response = await fetch('/api/debug/query-db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `
                            SELECT 
                                id, user_id, matches_used, last_match_at, 
                                last_match_games,
                                CASE WHEN last_match_games IS NOT NULL THEN jsonb_array_length(last_match_games::jsonb) ELSE 0 END as json_array_length,
                                CASE WHEN last_match_at > NOW() - INTERVAL '1 minute' THEN true ELSE false END as is_within_1_min,
                                EXTRACT(EPOCH FROM (NOW() - last_match_at))/60 as minutes_diff
                            FROM user_matching_sessions 
                            WHERE user_id = 38
                        `
                    })
                });
                
                const data = await response.json();
                showResult('database-result', '資料庫狀態詳細檢查', data);
                
            } catch (error) {
                showResult('database-result', '錯誤', { error: error.message }, 'error');
            }
        }
    </script>
</body>
</html>