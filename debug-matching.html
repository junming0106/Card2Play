<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…å°åŠŸèƒ½é™¤éŒ¯</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #e8f5e8; }
        .error { background-color: #ffe8e8; }
        .info { background-color: #e8f4ff; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 3px solid #007acc; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é…å°åŠŸèƒ½é™¤éŒ¯å·¥å…·</h1>

    <!-- è³‡æ–™åº«é€£ç·šæ¸¬è©¦ -->
    <div class="test-section info">
        <h3>1. è³‡æ–™åº«é€£ç·šæ¸¬è©¦</h3>
        <button onclick="testDatabaseConnection()">æ¸¬è©¦è³‡æ–™åº«</button>
        <div id="db-result" class="log"></div>
    </div>

    <!-- Firebase åˆå§‹åŒ–æ¸¬è©¦ -->
    <div class="test-section info">
        <h3>2. Firebase åˆå§‹åŒ–æ¸¬è©¦</h3>
        <button onclick="initializeFirebase()">åˆå§‹åŒ– Firebase</button>
        <button onclick="signInTest()">æ¸¬è©¦ç™»å…¥</button>
        <div id="firebase-result" class="log"></div>
    </div>

    <!-- é…å° API æ¸¬è©¦ -->
    <div class="test-section info">
        <h3>3. é…å° API æ¸¬è©¦</h3>
        <button onclick="testMatching()">æ¸¬è©¦é…å° (éœ€è¦ç™»å…¥)</button>
        <button onclick="testMatchingStatus()">æ¸¬è©¦ç‹€æ…‹æª¢æŸ¥</button>
        <div id="matching-result" class="log"></div>
    </div>

    <!-- ç•¶å‰ç‹€æ…‹é¡¯ç¤º -->
    <div class="test-section info">
        <h3>4. ç•¶å‰ç‹€æ…‹</h3>
        <div id="current-status" class="log">å°šæœªæª¢æŸ¥</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        let app, auth, user;

        // Firebase é…ç½® (ä½¿ç”¨ localhost ç’°å¢ƒçš„é…ç½®)
        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        // æ¸¬è©¦è³‡æ–™åº«é€£ç·š
        window.testDatabaseConnection = async function() {
            const resultDiv = document.getElementById('db-result');
            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦è³‡æ–™åº«é€£ç·š...';

            try {
                const response = await fetch('/api/db/init');
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<span style="color: green;">âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ</span><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: red;">âŒ è³‡æ–™åº«é€£ç·šå¤±æ•—</span><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">âŒ è³‡æ–™åº«æ¸¬è©¦éŒ¯èª¤: ${error.message}</span>`;
            }
        }

        // åˆå§‹åŒ– Firebase
        window.initializeFirebase = function() {
            const resultDiv = document.getElementById('firebase-result');
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                auth.onAuthStateChanged((currentUser) => {
                    user = currentUser;
                    updateCurrentStatus();
                });
                
                resultDiv.innerHTML = '<span style="color: green;">âœ… Firebase åˆå§‹åŒ–æˆåŠŸ</span>';
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">âŒ Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}</span>`;
            }
        }

        // æ¸¬è©¦ç™»å…¥
        window.signInTest = async function() {
            const resultDiv = document.getElementById('firebase-result');
            
            if (!auth) {
                resultDiv.innerHTML = '<span style="color: orange;">âš ï¸ è«‹å…ˆåˆå§‹åŒ– Firebase</span>';
                return;
            }

            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                user = result.user;
                
                resultDiv.innerHTML = `<span style="color: green;">âœ… ç™»å…¥æˆåŠŸ</span><br><pre>ç”¨æˆ¶: ${user.email}<br>UID: ${user.uid}</pre>`;
                updateCurrentStatus();
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">âŒ ç™»å…¥å¤±æ•—: ${error.message}</span>`;
            }
        }

        // æ¸¬è©¦é…å°åŠŸèƒ½
        window.testMatching = async function() {
            const resultDiv = document.getElementById('matching-result');
            
            if (!user) {
                resultDiv.innerHTML = '<span style="color: orange;">âš ï¸ è«‹å…ˆç™»å…¥</span>';
                return;
            }

            resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦é…å°åŠŸèƒ½...';

            try {
                const idToken = await user.getIdToken();
                console.log('ID Token é•·åº¦:', idToken.length);

                const response = await fetch('/api/matching-pg', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<span style="color: green;">âœ… é…å°æ¸¬è©¦æˆåŠŸ</span><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: red;">âŒ é…å°æ¸¬è©¦å¤±æ•—</span><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">âŒ é…å°æ¸¬è©¦éŒ¯èª¤: ${error.message}</span>`;
            }
        }

        // æ¸¬è©¦ç‹€æ…‹æª¢æŸ¥
        window.testMatchingStatus = async function() {
            const resultDiv = document.getElementById('matching-result');
            
            if (!user) {
                resultDiv.innerHTML = '<span style="color: orange;">âš ï¸ è«‹å…ˆç™»å…¥</span>';
                return;
            }

            resultDiv.innerHTML = 'æ­£åœ¨æª¢æŸ¥é…å°ç‹€æ…‹...';

            try {
                const idToken = await user.getIdToken();

                const response = await fetch('/api/matching-pg?status_only=true', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<span style="color: green;">âœ… ç‹€æ…‹æª¢æŸ¥æˆåŠŸ</span><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: red;">âŒ ç‹€æ…‹æª¢æŸ¥å¤±æ•—</span><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">âŒ ç‹€æ…‹æª¢æŸ¥éŒ¯èª¤: ${error.message}</span>`;
            }
        }

        // æ›´æ–°ç•¶å‰ç‹€æ…‹
        function updateCurrentStatus() {
            const statusDiv = document.getElementById('current-status');
            
            if (user) {
                statusDiv.innerHTML = `
                    <span style="color: green;">âœ… å·²ç™»å…¥</span><br>
                    <strong>ç”¨æˆ¶:</strong> ${user.email}<br>
                    <strong>UID:</strong> ${user.uid}<br>
                    <strong>Email é©—è­‰:</strong> ${user.emailVerified ? 'æ˜¯' : 'å¦'}<br>
                    <button onclick="signOut()">ç™»å‡º</button>
                `;
            } else {
                statusDiv.innerHTML = '<span style="color: orange;">âš ï¸ æœªç™»å…¥</span>';
            }
        }

        // ç™»å‡º
        window.signOut = async function() {
            try {
                await signOut(auth);
                user = null;
                document.getElementById('firebase-result').innerHTML += '<br><span style="color: blue;">ğŸ“¤ å·²ç™»å‡º</span>';
                updateCurrentStatus();
            } catch (error) {
                document.getElementById('firebase-result').innerHTML += `<br><span style="color: red;">âŒ ç™»å‡ºéŒ¯èª¤: ${error.message}</span>`;
            }
        }

        // åˆå§‹ç‹€æ…‹
        updateCurrentStatus();
    </script>
</body>
</html>