<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…å° API å®Œæ•´æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
        .success { border-color: #4caf50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fff8f0; }
        .info { border-color: #2196f3; background: #f0f8ff; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin: 15px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #2196f3; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-size: 12px; }
        .step { background: #e3f2fd; border-radius: 20px; padding: 5px 12px; color: #1565c0; font-weight: bold; margin-right: 10px; }
        .status-indicator { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .status-success { background: #4caf50; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-pending { background: #ff9800; color: white; }
        h3 { margin-top: 0; }
        .flow-step { margin: 10px 0; padding: 10px; border-left: 4px solid #2196f3; background: #f0f8ff; }
        .matches-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 15px 0; }
        .match-card { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .match-type-seeking { border-left: 4px solid #4caf50; }
        .match-type-offering { border-left: 4px solid #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª é…å° API å®Œæ•´æ¸¬è©¦</h1>
        <p>é€™å€‹å·¥å…·æœƒæ¸¬è©¦æ•´å€‹é…å°æµç¨‹ï¼ŒåŒ…æ‹¬æ­·å²è¨˜éŒ„çš„ä¿å­˜å’Œæ¢å¾©ã€‚</p>

        <div class="test-section info">
            <h3><span class="step">1</span>Firebase èªè­‰ <span id="auth-status" class="status-indicator status-pending">å¾…åˆå§‹åŒ–</span></h3>
            <button onclick="initializeAuth()">åˆå§‹åŒ– & ç™»å…¥</button>
            <button onclick="logOut()" disabled>ç™»å‡º</button>
            <div id="auth-result" class="result">è«‹é»æ“Šåˆå§‹åŒ–æŒ‰éˆ•é–‹å§‹</div>
        </div>

        <div class="test-section info">
            <h3><span class="step">2</span>æª¢æŸ¥ç”¨æˆ¶éŠæˆ²æ•¸æ“š <span id="games-status" class="status-indicator status-pending">æœªæª¢æŸ¥</span></h3>
            <button onclick="checkUserGames()" disabled>æª¢æŸ¥éŠæˆ²æ•¸æ“š</button>
            <div id="games-result" class="result">è«‹å…ˆå®Œæˆèªè­‰</div>
        </div>

        <div class="test-section info">
            <h3><span class="step">3</span>é…å°ç‹€æ…‹æª¢æŸ¥ <span id="status-status" class="status-indicator status-pending">æœªæª¢æŸ¥</span></h3>
            <button onclick="checkMatchingStatus()" disabled>æª¢æŸ¥é…å°ç‹€æ…‹</button>
            <div id="status-result" class="result">è«‹å…ˆå®Œæˆèªè­‰</div>
        </div>

        <div class="test-section info">
            <h3><span class="step">4</span>åŸ·è¡Œé…å° <span id="matching-status" class="status-indicator status-pending">æœªåŸ·è¡Œ</span></h3>
            <button onclick="performMatching()" disabled>åŸ·è¡Œé…å°</button>
            <div id="matching-result" class="result">è«‹å…ˆå®Œæˆå‰é¢æ­¥é©Ÿ</div>
        </div>

        <div class="test-section warning">
            <h3><span class="step">5</span>æ­·å²è¨˜éŒ„æ¸¬è©¦</h3>
            <div class="flow-step">
                <strong>æ¸¬è©¦æµç¨‹ï¼š</strong>
                <ol>
                    <li>å®Œæˆä¸Šé¢çš„é…å°æ­¥é©Ÿ</li>
                    <li>é»æ“Šä¸‹æ–¹ã€Œåˆ·æ–°é é¢ã€æŒ‰éˆ•</li>
                    <li>é‡æ–°ç™»å…¥</li>
                    <li>æª¢æŸ¥æ˜¯å¦è‡ªå‹•é¡¯ç¤ºæ­·å²è¨˜éŒ„</li>
                </ol>
            </div>
            <button onclick="window.location.reload()">ğŸ”„ åˆ·æ–°é é¢æ¸¬è©¦</button>
            <button onclick="simulatePageReturn()">ğŸ” æ¨¡æ“¬é‡è¿”é é¢</button>
        </div>

        <div id="matches-display" style="display: none;">
            <h3>ğŸ¯ é…å°çµæœå±•ç¤º</h3>
            <div id="matches-content" class="matches-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status-indicator status-${status}`;
            element.textContent = text;
        }

        function updateButtons() {
            const isLoggedIn = !!currentUser;
            const buttons = [
                'checkUserGames()',
                'checkMatchingStatus()',
                'performMatching()'
            ];
            
            buttons.forEach(btnFunc => {
                const btn = document.querySelector(`button[onclick="${btnFunc}"]`);
                if (btn) btn.disabled = !isLoggedIn;
            });
            
            document.querySelector('button[onclick="logOut()"]').disabled = !isLoggedIn;
        }

        function logResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            element.textContent += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
            
            if (isError) {
                element.style.color = '#d32f2f';
            }
        }

        function displayMatches(matches, title = "é…å°çµæœ") {
            if (!matches || matches.length === 0) return;
            
            const displayDiv = document.getElementById('matches-display');
            const contentDiv = document.getElementById('matches-content');
            
            displayDiv.style.display = 'block';
            contentDiv.innerHTML = matches.map(match => `
                <div class="match-card match-type-${match.matchType}">
                    <h4>ğŸ® ${match.gameTitle}</h4>
                    <p><strong>ğŸ‘¤ ç©å®¶ï¼š</strong>${match.playerName}</p>
                    <p><strong>ğŸ“§ Emailï¼š</strong>${match.playerEmail}</p>
                    <p><strong>ğŸ”„ é¡å‹ï¼š</strong>${match.matchType === 'seeking' ? 'ğŸ” ä½ æƒ³è¦çš„éŠæˆ²' : 'ğŸ å°æ–¹æƒ³è¦çš„éŠæˆ²'}</p>
                    <p><strong>â° æ™‚é–“ï¼š</strong>${match.addedAt || match.matchedAt || 'Unknown'}</p>
                </div>
            `).join('');
        }

        window.initializeAuth = async function() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            updateStatus('auth-status', 'success', 'å·²ç™»å…¥');
                            logResult('auth-result', `âœ… ç”¨æˆ¶ç™»å…¥æˆåŠŸ: ${user.email} (é©—è­‰: ${user.emailVerified})`);
                            
                            // è‡ªå‹•åŸ·è¡Œä¸‹ä¸€æ­¥
                            setTimeout(() => {
                                checkUserGames();
                            }, 500);
                        } else {
                            updateStatus('auth-status', 'error', 'æœªç™»å…¥');
                            logResult('auth-result', 'âŒ ç”¨æˆ¶æœªç™»å…¥');
                        }
                        updateButtons();
                    });
                }

                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
            } catch (error) {
                updateStatus('auth-status', 'error', 'èªè­‰å¤±æ•—');
                logResult('auth-result', `âŒ èªè­‰å¤±æ•—: ${error.message}`, true);
            }
        }

        window.logOut = async function() {
            try {
                await signOut(auth);
                updateStatus('auth-status', 'pending', 'å·²ç™»å‡º');
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
            }
        }

        window.checkUserGames = async function() {
            if (!currentUser) {
                updateStatus('games-status', 'error', 'éœ€è¦ç™»å…¥');
                return;
            }

            try {
                updateStatus('games-status', 'pending', 'æª¢æŸ¥ä¸­...');
                logResult('games-result', 'ğŸ” æ­£åœ¨æª¢æŸ¥ç”¨æˆ¶éŠæˆ²æ•¸æ“š...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/debug/user-games', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('games-status', 'success', 'æª¢æŸ¥å®Œæˆ');
                    logResult('games-result', `âœ… éŠæˆ²æ•¸æ“šæª¢æŸ¥å®Œæˆ:
- ç¸½éŠæˆ²æ•¸: ${data.user_games.total}
- æŒæœ‰éŠæˆ²: ${data.user_games.stats.owned_games}
- æƒ³è¦éŠæˆ²: ${data.user_games.stats.wanted_games}
- å…¶ä»–ç”¨æˆ¶éŠæˆ²: ${data.other_users_games.total}
- æ½›åœ¨é…å°: ${data.potential_matches.total}
- å¯ä»¥é…å°: ${data.summary.can_find_matches ? 'æ˜¯' : 'å¦'}`);

                    if (data.potential_matches.total > 0) {
                        logResult('games-result', `\nğŸ¯ æ½›åœ¨é…å°é è¦½:`);
                        data.potential_matches.matches.slice(0, 3).forEach((match, i) => {
                            logResult('games-result', `${i+1}. ${match.game_title} - ${match.other_user_name} (${match.match_type})`);
                        });
                    }

                    // è‡ªå‹•åŸ·è¡Œä¸‹ä¸€æ­¥
                    setTimeout(() => {
                        checkMatchingStatus();
                    }, 1000);
                } else {
                    updateStatus('games-status', 'error', 'æª¢æŸ¥å¤±æ•—');
                    logResult('games-result', `âŒ æª¢æŸ¥å¤±æ•—: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('games-status', 'error', 'æª¢æŸ¥éŒ¯èª¤');
                logResult('games-result', `âŒ æª¢æŸ¥éŒ¯èª¤: ${error.message}`, true);
            }
        }

        window.checkMatchingStatus = async function() {
            if (!currentUser) {
                updateStatus('status-status', 'error', 'éœ€è¦ç™»å…¥');
                return;
            }

            try {
                updateStatus('status-status', 'pending', 'æª¢æŸ¥ä¸­...');
                logResult('status-result', 'ğŸ“Š æ­£åœ¨æª¢æŸ¥é…å°ç‹€æ…‹...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg?status_only=true', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('status-status', 'success', 'æª¢æŸ¥å®Œæˆ');
                    
                    logResult('status-result', `âœ… é…å°ç‹€æ…‹æª¢æŸ¥å®Œæˆ:
- å·²ä½¿ç”¨æ¬¡æ•¸: ${data.matchesUsed}/3
- å‰©é¤˜æ¬¡æ•¸: ${data.matchesRemaining}
- æ˜¯å¦è¢«é™åˆ¶: ${data.rateLimited ? 'æ˜¯' : 'å¦'}
- é‡ç½®å€’æ•¸: ${data.secondsUntilReset} ç§’
- ç•¶å‰é…å°çµæœ: ${data.matches ? data.matches.length : 0} å€‹
- æ­·å²è¨˜éŒ„: ${data.recentMatches ? data.recentMatches.length : 0} å€‹`);

                    if (data.matches && data.matches.length > 0) {
                        logResult('status-result', `\nğŸ¯ ç•¶å‰é¡¯ç¤ºé…å°çµæœ:`);
                        data.matches.forEach((match, i) => {
                            logResult('status-result', `${i+1}. ${match.gameTitle} - ${match.playerName} (${match.matchType})`);
                        });
                        displayMatches(data.matches, "ç•¶å‰é…å°çµæœ");
                    }

                    if (data.recentMatches && data.recentMatches.length > 0) {
                        logResult('status-result', `\nğŸ“‹ æ­·å²è¨˜éŒ„:`);
                        data.recentMatches.forEach((match, i) => {
                            logResult('status-result', `${i+1}. ${match.gameTitle} - ${match.playerName} (${match.matchType})`);
                        });
                    }

                } else {
                    updateStatus('status-status', 'error', 'æª¢æŸ¥å¤±æ•—');
                    logResult('status-result', `âŒ ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('status-status', 'error', 'æª¢æŸ¥éŒ¯èª¤');
                logResult('status-result', `âŒ ç‹€æ…‹æª¢æŸ¥éŒ¯èª¤: ${error.message}`, true);
            }
        }

        window.performMatching = async function() {
            if (!currentUser) {
                updateStatus('matching-status', 'error', 'éœ€è¦ç™»å…¥');
                return;
            }

            try {
                updateStatus('matching-status', 'pending', 'é…å°ä¸­...');
                logResult('matching-result', 'ğŸ¯ æ­£åœ¨åŸ·è¡Œé…å°...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('matching-status', 'success', 'é…å°å®Œæˆ');
                    
                    logResult('matching-result', `âœ… é…å°åŸ·è¡Œå®Œæˆ:
- æ‰¾åˆ°é…å°: ${data.matches ? data.matches.length : 0} å€‹
- é…å°ç‹€æ…‹: ${data.matchesUsed}/3 (${data.rateLimited ? 'å·²é™åˆ¶' : 'å¯ç¹¼çºŒ'})
- é‡ç½®å€’æ•¸: ${data.secondsUntilReset} ç§’`);

                    if (data.matches && data.matches.length > 0) {
                        logResult('matching-result', `\nğŸ¯ é…å°çµæœè©³æƒ…:`);
                        data.matches.forEach((match, i) => {
                            logResult('matching-result', `${i+1}. ğŸ® ${match.gameTitle}
   ğŸ‘¤ ${match.playerName} (${match.playerEmail})
   ğŸ”„ ${match.matchType === 'seeking' ? 'å°æ–¹æŒæœ‰ä½ æƒ³è¦çš„éŠæˆ²' : 'å°æ–¹æƒ³è¦ä½ æŒæœ‰çš„éŠæˆ²'}`);
                        });
                        displayMatches(data.matches, "æ–°é…å°çµæœ");
                        
                        logResult('matching-result', `\nğŸ’¾ é…å°çµæœå·²ä¿å­˜åˆ°æ­·å²è¨˜éŒ„ï¼Œ1å°æ™‚å…§æœ‰æ•ˆï¼
ğŸ”„ ç¾åœ¨å¯ä»¥åˆ·æ–°é é¢æ¸¬è©¦æ­·å²è¨˜éŒ„æ¢å¾©åŠŸèƒ½`);
                    } else {
                        logResult('matching-result', `\nğŸ˜” æ²’æœ‰æ‰¾åˆ°æ–°çš„é…å°çµæœ
ğŸ’¡ å»ºè­°: ç¢ºä¿æœ‰è¶³å¤ çš„ã€Œæƒ³è¦äº¤æ›ã€éŠæˆ²å’Œå…¶ä»–ç”¨æˆ¶çš„ã€ŒæŒæœ‰ã€éŠæˆ²`);
                    }

                } else {
                    updateStatus('matching-status', 'error', 'é…å°å¤±æ•—');
                    logResult('matching-result', `âŒ é…å°å¤±æ•—: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('matching-status', 'error', 'é…å°éŒ¯èª¤');
                logResult('matching-result', `âŒ é…å°éŒ¯èª¤: ${error.message}`, true);
            }
        }

        window.simulatePageReturn = async function() {
            logResult('status-result', '\nğŸ”„ æ¨¡æ“¬é‡è¿”é é¢ï¼Œé‡æ–°æª¢æŸ¥ç‹€æ…‹...');
            await new Promise(resolve => setTimeout(resolve, 500));
            checkMatchingStatus();
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            console.log('ğŸ“± é é¢è¼‰å…¥å®Œæˆï¼Œæº–å‚™æ¸¬è©¦é…å°åŠŸèƒ½');
        });
    </script>
</body>
</html>