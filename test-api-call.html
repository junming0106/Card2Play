<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配對 API 完整測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
        .success { border-color: #4caf50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fff8f0; }
        .info { border-color: #2196f3; background: #f0f8ff; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin: 15px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #2196f3; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-size: 12px; }
        .step { background: #e3f2fd; border-radius: 20px; padding: 5px 12px; color: #1565c0; font-weight: bold; margin-right: 10px; }
        .status-indicator { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .status-success { background: #4caf50; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-pending { background: #ff9800; color: white; }
        h3 { margin-top: 0; }
        .flow-step { margin: 10px 0; padding: 10px; border-left: 4px solid #2196f3; background: #f0f8ff; }
        .matches-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 15px 0; }
        .match-card { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .match-type-seeking { border-left: 4px solid #4caf50; }
        .match-type-offering { border-left: 4px solid #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 配對 API 完整測試</h1>
        <p>這個工具會測試整個配對流程，包括歷史記錄的保存和恢復。</p>

        <div class="test-section info">
            <h3><span class="step">1</span>Firebase 認證 <span id="auth-status" class="status-indicator status-pending">待初始化</span></h3>
            <button onclick="initializeAuth()">初始化 & 登入</button>
            <button onclick="logOut()" disabled>登出</button>
            <div id="auth-result" class="result">請點擊初始化按鈕開始</div>
        </div>

        <div class="test-section info">
            <h3><span class="step">2</span>檢查用戶遊戲數據 <span id="games-status" class="status-indicator status-pending">未檢查</span></h3>
            <button onclick="checkUserGames()" disabled>檢查遊戲數據</button>
            <div id="games-result" class="result">請先完成認證</div>
        </div>

        <div class="test-section info">
            <h3><span class="step">3</span>配對狀態檢查 <span id="status-status" class="status-indicator status-pending">未檢查</span></h3>
            <button onclick="checkMatchingStatus()" disabled>檢查配對狀態</button>
            <div id="status-result" class="result">請先完成認證</div>
        </div>

        <div class="test-section info">
            <h3><span class="step">4</span>執行配對 <span id="matching-status" class="status-indicator status-pending">未執行</span></h3>
            <button onclick="performMatching()" disabled>執行配對</button>
            <div id="matching-result" class="result">請先完成前面步驟</div>
        </div>

        <div class="test-section warning">
            <h3><span class="step">5</span>歷史記錄測試</h3>
            <div class="flow-step">
                <strong>測試流程：</strong>
                <ol>
                    <li>完成上面的配對步驟</li>
                    <li>點擊下方「刷新頁面」按鈕</li>
                    <li>重新登入</li>
                    <li>檢查是否自動顯示歷史記錄</li>
                </ol>
            </div>
            <button onclick="window.location.reload()">🔄 刷新頁面測試</button>
            <button onclick="simulatePageReturn()">🔍 模擬重返頁面</button>
        </div>

        <div id="matches-display" style="display: none;">
            <h3>🎯 配對結果展示</h3>
            <div id="matches-content" class="matches-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status-indicator status-${status}`;
            element.textContent = text;
        }

        function updateButtons() {
            const isLoggedIn = !!currentUser;
            const buttons = [
                'checkUserGames()',
                'checkMatchingStatus()',
                'performMatching()'
            ];
            
            buttons.forEach(btnFunc => {
                const btn = document.querySelector(`button[onclick="${btnFunc}"]`);
                if (btn) btn.disabled = !isLoggedIn;
            });
            
            document.querySelector('button[onclick="logOut()"]').disabled = !isLoggedIn;
        }

        function logResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            element.textContent += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
            
            if (isError) {
                element.style.color = '#d32f2f';
            }
        }

        function displayMatches(matches, title = "配對結果") {
            if (!matches || matches.length === 0) return;
            
            const displayDiv = document.getElementById('matches-display');
            const contentDiv = document.getElementById('matches-content');
            
            displayDiv.style.display = 'block';
            contentDiv.innerHTML = matches.map(match => `
                <div class="match-card match-type-${match.matchType}">
                    <h4>🎮 ${match.gameTitle}</h4>
                    <p><strong>👤 玩家：</strong>${match.playerName}</p>
                    <p><strong>📧 Email：</strong>${match.playerEmail}</p>
                    <p><strong>🔄 類型：</strong>${match.matchType === 'seeking' ? '🔍 你想要的遊戲' : '🎁 對方想要的遊戲'}</p>
                    <p><strong>⏰ 時間：</strong>${match.addedAt || match.matchedAt || 'Unknown'}</p>
                </div>
            `).join('');
        }

        window.initializeAuth = async function() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            updateStatus('auth-status', 'success', '已登入');
                            logResult('auth-result', `✅ 用戶登入成功: ${user.email} (驗證: ${user.emailVerified})`);
                            
                            // 自動執行下一步
                            setTimeout(() => {
                                checkUserGames();
                            }, 500);
                        } else {
                            updateStatus('auth-status', 'error', '未登入');
                            logResult('auth-result', '❌ 用戶未登入');
                        }
                        updateButtons();
                    });
                }

                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
            } catch (error) {
                updateStatus('auth-status', 'error', '認證失敗');
                logResult('auth-result', `❌ 認證失敗: ${error.message}`, true);
            }
        }

        window.logOut = async function() {
            try {
                await signOut(auth);
                updateStatus('auth-status', 'pending', '已登出');
            } catch (error) {
                console.error('登出錯誤:', error);
            }
        }

        window.checkUserGames = async function() {
            if (!currentUser) {
                updateStatus('games-status', 'error', '需要登入');
                return;
            }

            try {
                updateStatus('games-status', 'pending', '檢查中...');
                logResult('games-result', '🔍 正在檢查用戶遊戲數據...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/debug/user-games', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('games-status', 'success', '檢查完成');
                    logResult('games-result', `✅ 遊戲數據檢查完成:
- 總遊戲數: ${data.user_games.total}
- 持有遊戲: ${data.user_games.stats.owned_games}
- 想要遊戲: ${data.user_games.stats.wanted_games}
- 其他用戶遊戲: ${data.other_users_games.total}
- 潛在配對: ${data.potential_matches.total}
- 可以配對: ${data.summary.can_find_matches ? '是' : '否'}`);

                    if (data.potential_matches.total > 0) {
                        logResult('games-result', `\n🎯 潛在配對預覽:`);
                        data.potential_matches.matches.slice(0, 3).forEach((match, i) => {
                            logResult('games-result', `${i+1}. ${match.game_title} - ${match.other_user_name} (${match.match_type})`);
                        });
                    }

                    // 自動執行下一步
                    setTimeout(() => {
                        checkMatchingStatus();
                    }, 1000);
                } else {
                    updateStatus('games-status', 'error', '檢查失敗');
                    logResult('games-result', `❌ 檢查失敗: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('games-status', 'error', '檢查錯誤');
                logResult('games-result', `❌ 檢查錯誤: ${error.message}`, true);
            }
        }

        window.checkMatchingStatus = async function() {
            if (!currentUser) {
                updateStatus('status-status', 'error', '需要登入');
                return;
            }

            try {
                updateStatus('status-status', 'pending', '檢查中...');
                logResult('status-result', '📊 正在檢查配對狀態...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg?status_only=true', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('status-status', 'success', '檢查完成');
                    
                    logResult('status-result', `✅ 配對狀態檢查完成:
- 已使用次數: ${data.matchesUsed}/3
- 剩餘次數: ${data.matchesRemaining}
- 是否被限制: ${data.rateLimited ? '是' : '否'}
- 重置倒數: ${data.secondsUntilReset} 秒
- 當前配對結果: ${data.matches ? data.matches.length : 0} 個
- 歷史記錄: ${data.recentMatches ? data.recentMatches.length : 0} 個`);

                    if (data.matches && data.matches.length > 0) {
                        logResult('status-result', `\n🎯 當前顯示配對結果:`);
                        data.matches.forEach((match, i) => {
                            logResult('status-result', `${i+1}. ${match.gameTitle} - ${match.playerName} (${match.matchType})`);
                        });
                        displayMatches(data.matches, "當前配對結果");
                    }

                    if (data.recentMatches && data.recentMatches.length > 0) {
                        logResult('status-result', `\n📋 歷史記錄:`);
                        data.recentMatches.forEach((match, i) => {
                            logResult('status-result', `${i+1}. ${match.gameTitle} - ${match.playerName} (${match.matchType})`);
                        });
                    }

                } else {
                    updateStatus('status-status', 'error', '檢查失敗');
                    logResult('status-result', `❌ 狀態檢查失敗: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('status-status', 'error', '檢查錯誤');
                logResult('status-result', `❌ 狀態檢查錯誤: ${error.message}`, true);
            }
        }

        window.performMatching = async function() {
            if (!currentUser) {
                updateStatus('matching-status', 'error', '需要登入');
                return;
            }

            try {
                updateStatus('matching-status', 'pending', '配對中...');
                logResult('matching-result', '🎯 正在執行配對...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('matching-status', 'success', '配對完成');
                    
                    logResult('matching-result', `✅ 配對執行完成:
- 找到配對: ${data.matches ? data.matches.length : 0} 個
- 配對狀態: ${data.matchesUsed}/3 (${data.rateLimited ? '已限制' : '可繼續'})
- 重置倒數: ${data.secondsUntilReset} 秒`);

                    if (data.matches && data.matches.length > 0) {
                        logResult('matching-result', `\n🎯 配對結果詳情:`);
                        data.matches.forEach((match, i) => {
                            logResult('matching-result', `${i+1}. 🎮 ${match.gameTitle}
   👤 ${match.playerName} (${match.playerEmail})
   🔄 ${match.matchType === 'seeking' ? '對方持有你想要的遊戲' : '對方想要你持有的遊戲'}`);
                        });
                        displayMatches(data.matches, "新配對結果");
                        
                        logResult('matching-result', `\n💾 配對結果已保存到歷史記錄，1小時內有效！
🔄 現在可以刷新頁面測試歷史記錄恢復功能`);
                    } else {
                        logResult('matching-result', `\n😔 沒有找到新的配對結果
💡 建議: 確保有足夠的「想要交換」遊戲和其他用戶的「持有」遊戲`);
                    }

                } else {
                    updateStatus('matching-status', 'error', '配對失敗');
                    logResult('matching-result', `❌ 配對失敗: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('matching-status', 'error', '配對錯誤');
                logResult('matching-result', `❌ 配對錯誤: ${error.message}`, true);
            }
        }

        window.simulatePageReturn = async function() {
            logResult('status-result', '\n🔄 模擬重返頁面，重新檢查狀態...');
            await new Promise(resolve => setTimeout(resolve, 500));
            checkMatchingStatus();
        }

        // 頁面載入時自動檢查
        window.addEventListener('load', () => {
            console.log('📱 頁面載入完成，準備測試配對功能');
        });
    </script>
</body>
</html>