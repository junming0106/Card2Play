<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…å°æ­·å²è¨˜éŒ„èª¿è©¦</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffe8e8; border-color: #f44336; }
        .warning { background: #fff8e1; border-color: #ff9800; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; }
        button:hover { background: #e9e9e9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-left: 3px solid #007acc; white-space: pre-wrap; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .inline-buttons { display: inline-block; margin-left: 10px; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é…å°æ­·å²è¨˜éŒ„èª¿è©¦å·¥å…·</h1>
        
        <div class="section">
            <h3>1. èº«ä»½é©—è­‰</h3>
            <button onclick="initAuth()">åˆå§‹åŒ– Firebase</button>
            <button onclick="signIn()" disabled>Google ç™»å…¥</button>
            <button onclick="signOutUser()" disabled>ç™»å‡º</button>
            <div id="auth-result" class="result">è«‹å…ˆåˆå§‹åŒ– Firebase</div>
        </div>
        
        <div class="section">
            <h3>2. èª¿è©¦é…å°æœƒè©±æ•¸æ“š</h3>
            <button onclick="debugSession()" disabled>æª¢æŸ¥æœƒè©±æ•¸æ“š</button>
            <div id="debug-result" class="result">è«‹å…ˆç™»å…¥</div>
        </div>
        
        <div class="section">
            <h3>3. é…å°ç‹€æ…‹æª¢æŸ¥</h3>
            <button onclick="checkStatus()" disabled>æª¢æŸ¥ç‹€æ…‹</button>
            <div id="status-result" class="result">è«‹å…ˆç™»å…¥</div>
        </div>
        
        <div class="section">
            <h3>4. åŸ·è¡Œé…å°</h3>
            <button onclick="performMatching()" disabled>é–‹å§‹é…å°</button>
            <div id="matching-result" class="result">è«‹å…ˆç™»å…¥</div>
        </div>
        
        <div class="section warning">
            <h3>5. æ¸¬è©¦æµç¨‹</h3>
            <p>å»ºè­°æ¸¬è©¦æ­¥é©Ÿï¼š</p>
            <ol>
                <li>åˆå§‹åŒ– Firebase ä¸¦ç™»å…¥</li>
                <li>æª¢æŸ¥æœƒè©±æ•¸æ“šï¼ˆäº†è§£ç•¶å‰ç‹€æ…‹ï¼‰</li>
                <li>åŸ·è¡Œé…å°ï¼ˆç”Ÿæˆæ­·å²è¨˜éŒ„ï¼‰</li>
                <li>åˆ·æ–°é é¢ <button onclick="window.location.reload()">åˆ·æ–°é é¢</button></li>
                <li>é‡æ–°ç™»å…¥ä¸¦æª¢æŸ¥ç‹€æ…‹ï¼ˆé©—è­‰æ­·å²è¨˜éŒ„ä¿å­˜ï¼‰</li>
            </ol>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;

        function updateButtonStates() {
            const isLoggedIn = !!currentUser;
            const buttons = ['signIn()', 'signOutUser()', 'debugSession()', 'checkStatus()', 'performMatching()'];
            buttons.forEach(func => {
                const btn = document.querySelector(`button[onclick="${func}"]`);
                if (btn) {
                    if (func === 'signIn()') {
                        btn.disabled = isLoggedIn || !auth;
                    } else if (func === 'signOutUser()') {
                        btn.disabled = !isLoggedIn;
                    } else {
                        btn.disabled = !isLoggedIn;
                    }
                }
            });
        }

        function formatTime() {
            return new Date().toLocaleTimeString('zh-TW', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        window.initAuth = function() {
            const resultDiv = document.getElementById('auth-result');
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        resultDiv.textContent = `âœ… å·²ç™»å…¥ [${formatTime()}]
ç”¨æˆ¶: ${user.email}
UID: ${user.uid}
Emailé©—è­‰: ${user.emailVerified}`;
                        resultDiv.parentElement.className = 'section success';
                    } else {
                        resultDiv.textContent = 'âŒ æœªç™»å…¥';
                        resultDiv.parentElement.className = 'section';
                    }
                    updateButtonStates();
                });
                
                resultDiv.textContent = 'âœ… Firebase åˆå§‹åŒ–æˆåŠŸ';
                updateButtonStates();
            } catch (error) {
                resultDiv.textContent = `âŒ Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.signIn = async function() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                const resultDiv = document.getElementById('auth-result');
                resultDiv.textContent = `âŒ ç™»å…¥å¤±æ•—: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.signOutUser = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
            }
        }

        window.debugSession = async function() {
            const resultDiv = document.getElementById('debug-result');
            try {
                resultDiv.textContent = 'æ­£åœ¨ç²å–æœƒè©±èª¿è©¦æ•¸æ“š...';
                resultDiv.parentElement.className = 'section';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/debug/matching-sessions', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    resultDiv.textContent = `âœ… æœƒè©±èª¿è©¦æ•¸æ“š [${formatTime()}]

ç”¨æˆ¶ä¿¡æ¯:
- ID: ${data.user.id}
- Email: ${data.user.email}
- å§“å: ${data.user.name}

é…å°æœƒè©±:
${data.session ? `- æœƒè©±ID: ${data.session.id}
- æœƒè©±é–‹å§‹: ${data.session.session_start}
- å·²ç”¨æ¬¡æ•¸: ${data.session.matches_used}
- æœ€å¾Œé…å°: ${data.session.last_match_at || 'ç„¡'}
- æœƒè©±éæœŸ: ${data.session.session_expired ? 'æ˜¯' : 'å¦'}
- é‡ç½®å€’æ•¸: ${data.session.seconds_until_reset} ç§’
- æœ‰è¿‘æœŸè¨˜éŒ„: ${data.session.has_recent_matches ? 'æ˜¯' : 'å¦'}
- è·é›¢æœ€å¾Œé…å°: ${data.session.minutes_since_last_match || 'N/A'} åˆ†é˜
- è¨˜éŒ„é¡å‹: ${data.session.last_match_games_type}` : '- ç„¡æœƒè©±è¨˜éŒ„'}

é…å°è¨˜éŒ„è§£æ:
- è§£ææˆåŠŸ: ${data.parsed_matches.success ? 'æ˜¯' : 'å¦'}
- è§£æéŒ¯èª¤: ${data.parsed_matches.error || 'ç„¡'}
- è¨˜éŒ„æ•¸é‡: ${data.parsed_matches.count}
${data.parsed_matches.data ? '- è¨˜éŒ„æ¨£æœ¬: ' + JSON.stringify(data.parsed_matches.data, null, 2) : ''}

æ™‚é–“ä¿¡æ¯:
- ç•¶å‰æ™‚é–“: ${data.current_time}
- è³‡æ–™åº«æ™‚é–“: ${data.database_time}`;
                    
                    resultDiv.parentElement.className = 'section success';
                } else {
                    resultDiv.textContent = `âŒ èª¿è©¦å¤±æ•—: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                resultDiv.textContent = `âŒ èª¿è©¦éŒ¯èª¤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.checkStatus = async function() {
            const resultDiv = document.getElementById('status-result');
            try {
                resultDiv.textContent = 'æ­£åœ¨æª¢æŸ¥é…å°ç‹€æ…‹...';
                resultDiv.parentElement.className = 'section';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg?status_only=true', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    resultDiv.textContent = `âœ… ç‹€æ…‹æª¢æŸ¥æˆåŠŸ [${formatTime()}]

é…å°ç‹€æ…‹:
- å·²ä½¿ç”¨: ${data.matchesUsed}/3
- å‰©é¤˜: ${data.matchesRemaining}
- è¢«é™åˆ¶: ${data.rateLimited ? 'æ˜¯' : 'å¦'}
- é‡ç½®å€’æ•¸: ${data.secondsUntilReset} ç§’

é…å°çµæœ: ${data.matches.length} å€‹
æ­·å²è¨˜éŒ„: ${data.recentMatches ? data.recentMatches.length : 0} å€‹

${data.matches.length > 0 ? 'ç•¶å‰é…å°:\n' + data.matches.map((m, i) => `${i+1}. ${m.gameTitle} - ${m.playerName} (${m.matchType})`).join('\n') : ''}

${data.recentMatches && data.recentMatches.length > 0 ? '\næ­·å²è¨˜éŒ„:\n' + data.recentMatches.map((m, i) => `${i+1}. ${m.gameTitle} - ${m.playerName} (${m.matchType})`).join('\n') : ''}`;
                    
                    resultDiv.parentElement.className = data.matches.length > 0 ? 'section success' : 'section';
                } else {
                    resultDiv.textContent = `âŒ ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                resultDiv.textContent = `âŒ ç‹€æ…‹æª¢æŸ¥éŒ¯èª¤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.performMatching = async function() {
            const resultDiv = document.getElementById('matching-result');
            try {
                resultDiv.textContent = 'æ­£åœ¨åŸ·è¡Œé…å°...';
                resultDiv.parentElement.className = 'section';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    resultDiv.textContent = `âœ… é…å°å®Œæˆ [${formatTime()}]

é…å°çµæœ: ${data.matches.length} å€‹
é…å°ç‹€æ…‹: ${data.matchesUsed}/3 (${data.rateLimited ? 'å·²é™åˆ¶' : 'å¯ç¹¼çºŒ'})

${data.matches.length > 0 ? 'æ‰¾åˆ°é…å°:\n' + data.matches.map((m, i) => 
`${i+1}. ğŸ® ${m.gameTitle}
   ğŸ‘¤ ${m.playerName} (${m.playerEmail})
   ğŸ”„ ${m.matchType === 'seeking' ? 'å°æ–¹æŒæœ‰ä½ æƒ³è¦çš„' : 'å°æ–¹æƒ³è¦ä½ æŒæœ‰çš„'}`).join('\n\n') : 'ğŸ˜” æ²’æœ‰æ‰¾åˆ°é…å°'}

ğŸ’¡ é…å°çµæœå·²ä¿å­˜åˆ°è³‡æ–™åº«ï¼Œ1å°æ™‚å…§æœ‰æ•ˆ
ğŸ”„ ç¾åœ¨å¯ä»¥åˆ·æ–°é é¢æ¸¬è©¦æ­·å²è¨˜éŒ„æ¢å¾©ï¼`;
                    
                    resultDiv.parentElement.className = data.matches.length > 0 ? 'section success' : 'section warning';
                } else {
                    resultDiv.textContent = `âŒ é…å°å¤±æ•—: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                resultDiv.textContent = `âŒ é…å°éŒ¯èª¤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        // åˆå§‹åŒ–
        updateButtonStates();
    </script>
</body>
</html>