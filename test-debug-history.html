<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配對歷史記錄調試</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffe8e8; border-color: #f44336; }
        .warning { background: #fff8e1; border-color: #ff9800; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; }
        button:hover { background: #e9e9e9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-left: 3px solid #007acc; white-space: pre-wrap; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .inline-buttons { display: inline-block; margin-left: 10px; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 配對歷史記錄調試工具</h1>
        
        <div class="section">
            <h3>1. 身份驗證</h3>
            <button onclick="initAuth()">初始化 Firebase</button>
            <button onclick="signIn()" disabled>Google 登入</button>
            <button onclick="signOutUser()" disabled>登出</button>
            <div id="auth-result" class="result">請先初始化 Firebase</div>
        </div>
        
        <div class="section">
            <h3>2. 調試配對會話數據</h3>
            <button onclick="debugSession()" disabled>檢查會話數據</button>
            <div id="debug-result" class="result">請先登入</div>
        </div>
        
        <div class="section">
            <h3>3. 配對狀態檢查</h3>
            <button onclick="checkStatus()" disabled>檢查狀態</button>
            <div id="status-result" class="result">請先登入</div>
        </div>
        
        <div class="section">
            <h3>4. 執行配對</h3>
            <button onclick="performMatching()" disabled>開始配對</button>
            <div id="matching-result" class="result">請先登入</div>
        </div>
        
        <div class="section warning">
            <h3>5. 測試流程</h3>
            <p>建議測試步驟：</p>
            <ol>
                <li>初始化 Firebase 並登入</li>
                <li>檢查會話數據（了解當前狀態）</li>
                <li>執行配對（生成歷史記錄）</li>
                <li>刷新頁面 <button onclick="window.location.reload()">刷新頁面</button></li>
                <li>重新登入並檢查狀態（驗證歷史記錄保存）</li>
            </ol>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;

        function updateButtonStates() {
            const isLoggedIn = !!currentUser;
            const buttons = ['signIn()', 'signOutUser()', 'debugSession()', 'checkStatus()', 'performMatching()'];
            buttons.forEach(func => {
                const btn = document.querySelector(`button[onclick="${func}"]`);
                if (btn) {
                    if (func === 'signIn()') {
                        btn.disabled = isLoggedIn || !auth;
                    } else if (func === 'signOutUser()') {
                        btn.disabled = !isLoggedIn;
                    } else {
                        btn.disabled = !isLoggedIn;
                    }
                }
            });
        }

        function formatTime() {
            return new Date().toLocaleTimeString('zh-TW', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        window.initAuth = function() {
            const resultDiv = document.getElementById('auth-result');
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        resultDiv.textContent = `✅ 已登入 [${formatTime()}]
用戶: ${user.email}
UID: ${user.uid}
Email驗證: ${user.emailVerified}`;
                        resultDiv.parentElement.className = 'section success';
                    } else {
                        resultDiv.textContent = '❌ 未登入';
                        resultDiv.parentElement.className = 'section';
                    }
                    updateButtonStates();
                });
                
                resultDiv.textContent = '✅ Firebase 初始化成功';
                updateButtonStates();
            } catch (error) {
                resultDiv.textContent = `❌ Firebase 初始化失敗: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.signIn = async function() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                const resultDiv = document.getElementById('auth-result');
                resultDiv.textContent = `❌ 登入失敗: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.signOutUser = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('登出錯誤:', error);
            }
        }

        window.debugSession = async function() {
            const resultDiv = document.getElementById('debug-result');
            try {
                resultDiv.textContent = '正在獲取會話調試數據...';
                resultDiv.parentElement.className = 'section';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/debug/matching-sessions', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    resultDiv.textContent = `✅ 會話調試數據 [${formatTime()}]

用戶信息:
- ID: ${data.user.id}
- Email: ${data.user.email}
- 姓名: ${data.user.name}

配對會話:
${data.session ? `- 會話ID: ${data.session.id}
- 會話開始: ${data.session.session_start}
- 已用次數: ${data.session.matches_used}
- 最後配對: ${data.session.last_match_at || '無'}
- 會話過期: ${data.session.session_expired ? '是' : '否'}
- 重置倒數: ${data.session.seconds_until_reset} 秒
- 有近期記錄: ${data.session.has_recent_matches ? '是' : '否'}
- 距離最後配對: ${data.session.minutes_since_last_match || 'N/A'} 分鐘
- 記錄類型: ${data.session.last_match_games_type}` : '- 無會話記錄'}

配對記錄解析:
- 解析成功: ${data.parsed_matches.success ? '是' : '否'}
- 解析錯誤: ${data.parsed_matches.error || '無'}
- 記錄數量: ${data.parsed_matches.count}
${data.parsed_matches.data ? '- 記錄樣本: ' + JSON.stringify(data.parsed_matches.data, null, 2) : ''}

時間信息:
- 當前時間: ${data.current_time}
- 資料庫時間: ${data.database_time}`;
                    
                    resultDiv.parentElement.className = 'section success';
                } else {
                    resultDiv.textContent = `❌ 調試失敗: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                resultDiv.textContent = `❌ 調試錯誤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.checkStatus = async function() {
            const resultDiv = document.getElementById('status-result');
            try {
                resultDiv.textContent = '正在檢查配對狀態...';
                resultDiv.parentElement.className = 'section';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg?status_only=true', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    resultDiv.textContent = `✅ 狀態檢查成功 [${formatTime()}]

配對狀態:
- 已使用: ${data.matchesUsed}/3
- 剩餘: ${data.matchesRemaining}
- 被限制: ${data.rateLimited ? '是' : '否'}
- 重置倒數: ${data.secondsUntilReset} 秒

配對結果: ${data.matches.length} 個
歷史記錄: ${data.recentMatches ? data.recentMatches.length : 0} 個

${data.matches.length > 0 ? '當前配對:\n' + data.matches.map((m, i) => `${i+1}. ${m.gameTitle} - ${m.playerName} (${m.matchType})`).join('\n') : ''}

${data.recentMatches && data.recentMatches.length > 0 ? '\n歷史記錄:\n' + data.recentMatches.map((m, i) => `${i+1}. ${m.gameTitle} - ${m.playerName} (${m.matchType})`).join('\n') : ''}`;
                    
                    resultDiv.parentElement.className = data.matches.length > 0 ? 'section success' : 'section';
                } else {
                    resultDiv.textContent = `❌ 狀態檢查失敗: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                resultDiv.textContent = `❌ 狀態檢查錯誤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.performMatching = async function() {
            const resultDiv = document.getElementById('matching-result');
            try {
                resultDiv.textContent = '正在執行配對...';
                resultDiv.parentElement.className = 'section';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    resultDiv.textContent = `✅ 配對完成 [${formatTime()}]

配對結果: ${data.matches.length} 個
配對狀態: ${data.matchesUsed}/3 (${data.rateLimited ? '已限制' : '可繼續'})

${data.matches.length > 0 ? '找到配對:\n' + data.matches.map((m, i) => 
`${i+1}. 🎮 ${m.gameTitle}
   👤 ${m.playerName} (${m.playerEmail})
   🔄 ${m.matchType === 'seeking' ? '對方持有你想要的' : '對方想要你持有的'}`).join('\n\n') : '😔 沒有找到配對'}

💡 配對結果已保存到資料庫，1小時內有效
🔄 現在可以刷新頁面測試歷史記錄恢復！`;
                    
                    resultDiv.parentElement.className = data.matches.length > 0 ? 'section success' : 'section warning';
                } else {
                    resultDiv.textContent = `❌ 配對失敗: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                resultDiv.textContent = `❌ 配對錯誤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        // 初始化
        updateButtonStates();
    </script>
</body>
</html>