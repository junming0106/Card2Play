<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­·å²è¨˜éŒ„æ™‚æ•ˆæ€§æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background: #f0f4f8; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 2px solid #e1e5e9; border-radius: 8px; position: relative; }
        .success { border-color: #28a745; background: #f8fff9; }
        .error { border-color: #dc3545; background: #fff8f8; }
        .warning { border-color: #ffc107; background: #fffcf0; }
        .info { border-color: #17a2b8; background: #f0fdff; }
        .step-badge { position: absolute; top: -12px; left: 20px; background: #007bff; color: white; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        button { padding: 12px 20px; margin: 8px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 6px; font-size: 14px; transition: all 0.3s; }
        button:hover { background: #0056b3; transform: translateY(-1px); }
        button:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #1e7e34; }
        .result { margin: 15px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 13px; border-radius: 0 5px 5px 0; }
        .timeline { background: #e9ecef; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .timeline-item { margin: 8px 0; padding: 8px 12px; background: white; border-left: 4px solid #007bff; border-radius: 0 5px 5px 0; }
        .matches-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 15px 0; }
        .match-card { background: #fff; border: 2px solid #e1e5e9; padding: 15px; border-radius: 8px; position: relative; }
        .match-card.historical { border-color: #ffc107; background: #fffcf0; }
        .match-card.fresh { border-color: #28a745; background: #f8fff9; }
        .match-type { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; }
        .match-seeking { background: #17a2b8; }
        .match-offering { background: #6f42c1; }
        .timer-display { text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; margin: 15px 0; }
        .timer-big { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-pending { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° æ­·å²è¨˜éŒ„æ™‚æ•ˆæ€§æ¸¬è©¦å·¥å…·</h1>
        <p>é€™å€‹å·¥å…·å°ˆé–€æ¸¬è©¦é…å°æ­·å²è¨˜éŒ„çš„1å°æ™‚æ™‚æ•ˆæ€§ç®¡ç†åŠŸèƒ½ã€‚</p>

        <div class="test-section info">
            <div class="step-badge">æ­¥é©Ÿ 1</div>
            <h3><span class="status-indicator status-pending" id="auth-indicator"></span>Firebase èªè­‰</h3>
            <button onclick="initAuth()">åˆå§‹åŒ– & ç™»å…¥</button>
            <button onclick="logout()" disabled>ç™»å‡º</button>
            <div id="auth-result" class="result">ç­‰å¾…åˆå§‹åŒ–...</div>
        </div>

        <div class="test-section info">
            <div class="step-badge">æ­¥é©Ÿ 2</div>
            <h3><span class="status-indicator status-pending" id="status-indicator"></span>æª¢æŸ¥ç•¶å‰ç‹€æ…‹</h3>
            <button onclick="checkCurrentStatus()" disabled>æª¢æŸ¥ç‹€æ…‹</button>
            <div id="status-result" class="result">è«‹å…ˆå®Œæˆèªè­‰</div>
        </div>

        <div class="test-section info">
            <div class="step-badge">æ­¥é©Ÿ 3</div>
            <h3><span class="status-indicator status-pending" id="matching-indicator"></span>åŸ·è¡Œé…å°æ¸¬è©¦</h3>
            <button onclick="performMatchingTest()" disabled>åŸ·è¡Œé…å°</button>
            <div id="matching-result" class="result">è«‹å…ˆå®Œæˆå‰é¢æ­¥é©Ÿ</div>
        </div>

        <div class="test-section warning">
            <div class="step-badge">æ­¥é©Ÿ 4</div>
            <h3>â° æ™‚æ•ˆæ€§æ¸¬è©¦</h3>
            <div class="timer-display" id="timer-display" style="display: none;">
                <div>æ­·å²è¨˜éŒ„å‰©é¤˜æ™‚é–“</div>
                <div class="timer-big" id="timer-big">--:--</div>
                <div id="timer-status">ç­‰å¾…é…å°å®Œæˆ...</div>
            </div>
            <button onclick="refreshTest()" disabled>ğŸ”„ åˆ·æ–°æ¸¬è©¦æ­·å²è¨˜éŒ„</button>
            <button onclick="simulateExpiry()" class="danger" disabled>âš ï¸ æ¨¡æ“¬è¨˜éŒ„éæœŸ</button>
            <div id="timing-result" class="result">åŸ·è¡Œé…å°å¾Œæ‰èƒ½æ¸¬è©¦æ™‚æ•ˆæ€§</div>
        </div>

        <div class="test-section success" style="display: none;" id="matches-section">
            <div class="step-badge">çµæœ</div>
            <h3>ğŸ¯ é…å°çµæœå±•ç¤º</h3>
            <div id="matches-display" class="matches-display"></div>
        </div>

        <div class="test-section info">
            <div class="step-badge">è¨˜éŒ„</div>
            <h3>ğŸ“‹ æ¸¬è©¦æ™‚é–“è»¸</h3>
            <div id="timeline" class="timeline">
                <div class="timeline-item">æ¸¬è©¦é–‹å§‹...</div>
            </div>
            <button onclick="clearTimeline()">æ¸…ç©ºè¨˜éŒ„</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;
        let testData = {
            lastMatchTime: null,
            historyInfo: null,
            timerInterval: null
        };

        function updateStatus(indicatorId, status) {
            const indicator = document.getElementById(indicatorId);
            indicator.className = `status-indicator status-${status}`;
        }

        function addTimeline(message) {
            const timeline = document.getElementById('timeline');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.textContent = `[${timestamp}] ${message}`;
            timeline.appendChild(item);
            timeline.scrollTop = timeline.scrollHeight;
        }

        function logResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            element.textContent += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
            
            if (isError) {
                element.style.borderColor = '#dc3545';
            }
            
            addTimeline(message);
        }

        function updateButtons() {
            const isLoggedIn = !!currentUser;
            const buttons = ['checkCurrentStatus()', 'performMatchingTest()', 'refreshTest()', 'simulateExpiry()'];
            buttons.forEach(func => {
                const btn = document.querySelector(`button[onclick="${func}"]`);
                if (btn) btn.disabled = !isLoggedIn;
            });
            document.querySelector('button[onclick="logout()"]').disabled = !isLoggedIn;
        }

        function startHistoryTimer(historyInfo) {
            if (testData.timerInterval) {
                clearInterval(testData.timerInterval);
            }

            const timerDisplay = document.getElementById('timer-display');
            const timerBig = document.getElementById('timer-big');
            const timerStatus = document.getElementById('timer-status');
            
            timerDisplay.style.display = 'block';
            
            let remainingSeconds = historyInfo.remainingMinutes * 60;
            
            testData.timerInterval = setInterval(() => {
                remainingSeconds = Math.max(0, remainingSeconds - 1);
                
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                timerBig.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (remainingSeconds > 600) { // 10åˆ†é˜ä»¥ä¸Š
                    timerStatus.textContent = 'è¨˜éŒ„æœ‰æ•ˆä¸­...';
                    timerDisplay.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                } else if (remainingSeconds > 0) { // 10åˆ†é˜å…§
                    timerStatus.textContent = 'âš ï¸ å³å°‡éæœŸï¼';
                    timerDisplay.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                } else {
                    timerStatus.textContent = 'âŒ å·²éæœŸ';
                    timerDisplay.style.background = 'linear-gradient(135deg, #4b6cb7 0%, #182848 100%)';
                    clearInterval(testData.timerInterval);
                    addTimeline('â° æ­·å²è¨˜éŒ„è¨ˆæ™‚å™¨é¡¯ç¤ºå·²éæœŸ');
                }
            }, 1000);
        }

        function displayMatches(matches, historyInfo = null) {
            if (!matches || matches.length === 0) return;

            const section = document.getElementById('matches-section');
            const display = document.getElementById('matches-display');
            
            section.style.display = 'block';
            
            display.innerHTML = matches.map(match => `
                <div class="match-card ${historyInfo?.isHistorical ? 'historical' : 'fresh'}">
                    <div class="match-type ${match.matchType === 'seeking' ? 'match-seeking' : 'match-offering'}">
                        ${match.matchType === 'seeking' ? 'ğŸ” æƒ³è¦' : 'ğŸ æä¾›'}
                    </div>
                    <h4>ğŸ® ${match.gameTitle}</h4>
                    <p><strong>ğŸ‘¤ ç©å®¶ï¼š</strong>${match.playerName}</p>
                    <p><strong>ğŸ“§ è¯çµ¡ï¼š</strong>${match.playerEmail}</p>
                    <p><strong>â° æ™‚é–“ï¼š</strong>${match.addedAt || match.matchedAt || 'Unknown'}</p>
                    ${historyInfo?.isHistorical ? 
                        `<p><strong>ğŸ•’ ç‹€æ…‹ï¼š</strong>æ­·å²è¨˜éŒ„ (${historyInfo.remainingMinutes} åˆ†é˜å¾ŒéæœŸ)</p>` : 
                        '<p><strong>ğŸ†• ç‹€æ…‹ï¼š</strong>æ–°é…å°çµæœ</p>'
                    }
                </div>
            `).join('');

            if (historyInfo?.isHistorical) {
                startHistoryTimer(historyInfo);
                addTimeline(`ğŸ“‹ é¡¯ç¤ºæ­·å²è¨˜éŒ„ (${matches.length} å€‹)ï¼Œå‰©é¤˜ ${historyInfo.remainingMinutes} åˆ†é˜`);
            } else {
                addTimeline(`ğŸ†• é¡¯ç¤ºæ–°é…å°çµæœ (${matches.length} å€‹)`);
            }
        }

        window.initAuth = async function() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            updateStatus('auth-indicator', 'success');
                            logResult('auth-result', `âœ… ç™»å…¥æˆåŠŸ: ${user.email}`);
                            addTimeline(`ç”¨æˆ¶ç™»å…¥: ${user.email}`);
                        } else {
                            updateStatus('auth-indicator', 'error');
                            logResult('auth-result', 'âŒ æœªç™»å…¥');
                        }
                        updateButtons();
                    });
                }

                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
            } catch (error) {
                updateStatus('auth-indicator', 'error');
                logResult('auth-result', `âŒ ç™»å…¥å¤±æ•—: ${error.message}`, true);
            }
        }

        window.logout = async function() {
            try {
                await signOut(auth);
                updateStatus('auth-indicator', 'pending');
                if (testData.timerInterval) {
                    clearInterval(testData.timerInterval);
                    document.getElementById('timer-display').style.display = 'none';
                }
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
            }
        }

        window.checkCurrentStatus = async function() {
            if (!currentUser) return;

            try {
                updateStatus('status-indicator', 'pending');
                logResult('status-result', 'ğŸ” æª¢æŸ¥ç•¶å‰é…å°ç‹€æ…‹...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg?status_only=true', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('status-indicator', 'success');
                    
                    logResult('status-result', `âœ… ç‹€æ…‹æª¢æŸ¥å®Œæˆ:
- é…å°æ¬¡æ•¸: ${data.matchesUsed}/3
- å‰©é¤˜æ¬¡æ•¸: ${data.matchesRemaining}
- ç•¶å‰çµæœ: ${data.matches ? data.matches.length : 0} å€‹
- æ­·å²è¨˜éŒ„: ${data.recentMatches ? data.recentMatches.length : 0} å€‹
- æ˜¯æ­·å²è¨˜éŒ„: ${data.historyInfo?.isHistorical ? 'æ˜¯' : 'å¦'}
${data.historyInfo?.isHistorical ? `- å‰©é¤˜æ™‚é–“: ${data.historyInfo.remainingMinutes} åˆ†é˜` : ''}`);

                    if (data.matches && data.matches.length > 0) {
                        displayMatches(data.matches, data.historyInfo);
                        testData.historyInfo = data.historyInfo;
                    }

                    addTimeline(`ç‹€æ…‹æª¢æŸ¥: ${data.matches?.length || 0} å€‹é…å°çµæœ`);
                } else {
                    updateStatus('status-indicator', 'error');
                    logResult('status-result', `âŒ ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('status-indicator', 'error');
                logResult('status-result', `âŒ ç‹€æ…‹æª¢æŸ¥éŒ¯èª¤: ${error.message}`, true);
            }
        }

        window.performMatchingTest = async function() {
            if (!currentUser) return;

            try {
                updateStatus('matching-indicator', 'pending');
                logResult('matching-result', 'ğŸ¯ åŸ·è¡Œé…å°æ¸¬è©¦...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('matching-indicator', 'success');
                    testData.lastMatchTime = new Date();
                    
                    logResult('matching-result', `âœ… é…å°æ¸¬è©¦å®Œæˆ:
- æ‰¾åˆ°é…å°: ${data.matches ? data.matches.length : 0} å€‹
- é…å°ç‹€æ…‹: ${data.matchesUsed}/3
- æ­·å²ä¿¡æ¯: ${data.historyInfo ? 'æœ‰' : 'ç„¡'}
${data.historyInfo ? `- å‰©é¤˜æ™‚é–“: ${data.historyInfo.remainingMinutes} åˆ†é˜` : ''}`);

                    if (data.matches && data.matches.length > 0) {
                        displayMatches(data.matches, data.historyInfo);
                        testData.historyInfo = data.historyInfo;
                        
                        logResult('matching-result', `\nğŸ’¾ é…å°çµæœå·²ä¿å­˜ï¼Œ1å°æ™‚å…§æœ‰æ•ˆ
ğŸ”„ ç¾åœ¨å¯ä»¥æ¸¬è©¦åˆ·æ–°é é¢æˆ–æ™‚æ•ˆæ€§åŠŸèƒ½`);
                        
                        // å•Ÿç”¨æ™‚æ•ˆæ€§æ¸¬è©¦æŒ‰éˆ•
                        document.querySelector('button[onclick="refreshTest()"]').disabled = false;
                        document.querySelector('button[onclick="simulateExpiry()"]').disabled = false;
                    }

                    addTimeline(`é…å°å®Œæˆ: ${data.matches?.length || 0} å€‹çµæœï¼Œé–‹å§‹è¨ˆæ™‚`);
                } else {
                    updateStatus('matching-indicator', 'error');
                    logResult('matching-result', `âŒ é…å°æ¸¬è©¦å¤±æ•—: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('matching-indicator', 'error');
                logResult('matching-result', `âŒ é…å°æ¸¬è©¦éŒ¯èª¤: ${error.message}`, true);
            }
        }

        window.refreshTest = async function() {
            addTimeline('ğŸ”„ åŸ·è¡Œåˆ·æ–°æ¸¬è©¦...');
            logResult('timing-result', 'ğŸ”„ æ¨¡æ“¬é é¢åˆ·æ–°ï¼Œé‡æ–°æª¢æŸ¥ç‹€æ…‹...');
            await new Promise(resolve => setTimeout(resolve, 500));
            await checkCurrentStatus();
            logResult('timing-result', 'âœ… åˆ·æ–°æ¸¬è©¦å®Œæˆï¼Œæª¢æŸ¥æ­·å²è¨˜éŒ„æ˜¯å¦æ­£ç¢ºé¡¯ç¤º');
        }

        window.simulateExpiry = async function() {
            if (!testData.historyInfo) {
                logResult('timing-result', 'âš ï¸ æ²’æœ‰æ­·å²è¨˜éŒ„å¯ä»¥æ¸¬è©¦', true);
                return;
            }

            addTimeline('âš ï¸ æ¨¡æ“¬è¨˜éŒ„éæœŸæ¸¬è©¦...');
            logResult('timing-result', 'âš ï¸ æ³¨æ„ï¼šé€™å°‡æ¸…é™¤ç•¶å‰æ­·å²è¨˜éŒ„ç”¨æ–¼æ¸¬è©¦');
            
            // ç­‰å¾…ç”¨æˆ¶ç¢ºèª
            if (!confirm('ç¢ºå®šè¦æ¨¡æ“¬æ­·å²è¨˜éŒ„éæœŸå—ï¼Ÿé€™å°‡æ¸…é™¤ç•¶å‰çš„æ­·å²è¨˜éŒ„ã€‚')) {
                return;
            }

            try {
                const idToken = await currentUser.getIdToken();
                // ç›´æ¥èª¿ç”¨æ¸…ç†API
                const response = await fetch('/api/debug/matching-sessions', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                logResult('timing-result', 'ğŸ§¹ å·²è§¸ç™¼éæœŸæ¸…ç†ï¼Œé‡æ–°æª¢æŸ¥ç‹€æ…‹...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                await checkCurrentStatus();
                addTimeline('éæœŸæ¸¬è©¦å®Œæˆ');
            } catch (error) {
                logResult('timing-result', `âŒ éæœŸæ¸¬è©¦éŒ¯èª¤: ${error.message}`, true);
            }
        }

        window.clearTimeline = function() {
            document.getElementById('timeline').innerHTML = '<div class="timeline-item">æ™‚é–“è»¸å·²æ¸…ç©º...</div>';
        }

        // åˆå§‹åŒ–
        addTimeline('æ¸¬è©¦å·¥å…·è¼‰å…¥å®Œæˆ');
        updateButtons();
    </script>
</body>
</html>