<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歷史記錄時效性測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background: #f0f4f8; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 2px solid #e1e5e9; border-radius: 8px; position: relative; }
        .success { border-color: #28a745; background: #f8fff9; }
        .error { border-color: #dc3545; background: #fff8f8; }
        .warning { border-color: #ffc107; background: #fffcf0; }
        .info { border-color: #17a2b8; background: #f0fdff; }
        .step-badge { position: absolute; top: -12px; left: 20px; background: #007bff; color: white; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        button { padding: 12px 20px; margin: 8px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 6px; font-size: 14px; transition: all 0.3s; }
        button:hover { background: #0056b3; transform: translateY(-1px); }
        button:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #1e7e34; }
        .result { margin: 15px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 13px; border-radius: 0 5px 5px 0; }
        .timeline { background: #e9ecef; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .timeline-item { margin: 8px 0; padding: 8px 12px; background: white; border-left: 4px solid #007bff; border-radius: 0 5px 5px 0; }
        .matches-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 15px 0; }
        .match-card { background: #fff; border: 2px solid #e1e5e9; padding: 15px; border-radius: 8px; position: relative; }
        .match-card.historical { border-color: #ffc107; background: #fffcf0; }
        .match-card.fresh { border-color: #28a745; background: #f8fff9; }
        .match-type { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; }
        .match-seeking { background: #17a2b8; }
        .match-offering { background: #6f42c1; }
        .timer-display { text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; margin: 15px 0; }
        .timer-big { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-pending { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>⏰ 歷史記錄時效性測試工具</h1>
        <p>這個工具專門測試配對歷史記錄的1小時時效性管理功能。</p>

        <div class="test-section info">
            <div class="step-badge">步驟 1</div>
            <h3><span class="status-indicator status-pending" id="auth-indicator"></span>Firebase 認證</h3>
            <button onclick="initAuth()">初始化 & 登入</button>
            <button onclick="logout()" disabled>登出</button>
            <div id="auth-result" class="result">等待初始化...</div>
        </div>

        <div class="test-section info">
            <div class="step-badge">步驟 2</div>
            <h3><span class="status-indicator status-pending" id="status-indicator"></span>檢查當前狀態</h3>
            <button onclick="checkCurrentStatus()" disabled>檢查狀態</button>
            <div id="status-result" class="result">請先完成認證</div>
        </div>

        <div class="test-section info">
            <div class="step-badge">步驟 3</div>
            <h3><span class="status-indicator status-pending" id="matching-indicator"></span>執行配對測試</h3>
            <button onclick="performMatchingTest()" disabled>執行配對</button>
            <div id="matching-result" class="result">請先完成前面步驟</div>
        </div>

        <div class="test-section warning">
            <div class="step-badge">步驟 4</div>
            <h3>⏰ 時效性測試</h3>
            <div class="timer-display" id="timer-display" style="display: none;">
                <div>歷史記錄剩餘時間</div>
                <div class="timer-big" id="timer-big">--:--</div>
                <div id="timer-status">等待配對完成...</div>
            </div>
            <button onclick="refreshTest()" disabled>🔄 刷新測試歷史記錄</button>
            <button onclick="simulateExpiry()" class="danger" disabled>⚠️ 模擬記錄過期</button>
            <div id="timing-result" class="result">執行配對後才能測試時效性</div>
        </div>

        <div class="test-section success" style="display: none;" id="matches-section">
            <div class="step-badge">結果</div>
            <h3>🎯 配對結果展示</h3>
            <div id="matches-display" class="matches-display"></div>
        </div>

        <div class="test-section info">
            <div class="step-badge">記錄</div>
            <h3>📋 測試時間軸</h3>
            <div id="timeline" class="timeline">
                <div class="timeline-item">測試開始...</div>
            </div>
            <button onclick="clearTimeline()">清空記錄</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;
        let testData = {
            lastMatchTime: null,
            historyInfo: null,
            timerInterval: null
        };

        function updateStatus(indicatorId, status) {
            const indicator = document.getElementById(indicatorId);
            indicator.className = `status-indicator status-${status}`;
        }

        function addTimeline(message) {
            const timeline = document.getElementById('timeline');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.textContent = `[${timestamp}] ${message}`;
            timeline.appendChild(item);
            timeline.scrollTop = timeline.scrollHeight;
        }

        function logResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            element.textContent += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
            
            if (isError) {
                element.style.borderColor = '#dc3545';
            }
            
            addTimeline(message);
        }

        function updateButtons() {
            const isLoggedIn = !!currentUser;
            const buttons = ['checkCurrentStatus()', 'performMatchingTest()', 'refreshTest()', 'simulateExpiry()'];
            buttons.forEach(func => {
                const btn = document.querySelector(`button[onclick="${func}"]`);
                if (btn) btn.disabled = !isLoggedIn;
            });
            document.querySelector('button[onclick="logout()"]').disabled = !isLoggedIn;
        }

        function startHistoryTimer(historyInfo) {
            if (testData.timerInterval) {
                clearInterval(testData.timerInterval);
            }

            const timerDisplay = document.getElementById('timer-display');
            const timerBig = document.getElementById('timer-big');
            const timerStatus = document.getElementById('timer-status');
            
            timerDisplay.style.display = 'block';
            
            let remainingSeconds = historyInfo.remainingMinutes * 60;
            
            testData.timerInterval = setInterval(() => {
                remainingSeconds = Math.max(0, remainingSeconds - 1);
                
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                timerBig.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (remainingSeconds > 600) { // 10分鐘以上
                    timerStatus.textContent = '記錄有效中...';
                    timerDisplay.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                } else if (remainingSeconds > 0) { // 10分鐘內
                    timerStatus.textContent = '⚠️ 即將過期！';
                    timerDisplay.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                } else {
                    timerStatus.textContent = '❌ 已過期';
                    timerDisplay.style.background = 'linear-gradient(135deg, #4b6cb7 0%, #182848 100%)';
                    clearInterval(testData.timerInterval);
                    addTimeline('⏰ 歷史記錄計時器顯示已過期');
                }
            }, 1000);
        }

        function displayMatches(matches, historyInfo = null) {
            if (!matches || matches.length === 0) return;

            const section = document.getElementById('matches-section');
            const display = document.getElementById('matches-display');
            
            section.style.display = 'block';
            
            display.innerHTML = matches.map(match => `
                <div class="match-card ${historyInfo?.isHistorical ? 'historical' : 'fresh'}">
                    <div class="match-type ${match.matchType === 'seeking' ? 'match-seeking' : 'match-offering'}">
                        ${match.matchType === 'seeking' ? '🔍 想要' : '🎁 提供'}
                    </div>
                    <h4>🎮 ${match.gameTitle}</h4>
                    <p><strong>👤 玩家：</strong>${match.playerName}</p>
                    <p><strong>📧 聯絡：</strong>${match.playerEmail}</p>
                    <p><strong>⏰ 時間：</strong>${match.addedAt || match.matchedAt || 'Unknown'}</p>
                    ${historyInfo?.isHistorical ? 
                        `<p><strong>🕒 狀態：</strong>歷史記錄 (${historyInfo.remainingMinutes} 分鐘後過期)</p>` : 
                        '<p><strong>🆕 狀態：</strong>新配對結果</p>'
                    }
                </div>
            `).join('');

            if (historyInfo?.isHistorical) {
                startHistoryTimer(historyInfo);
                addTimeline(`📋 顯示歷史記錄 (${matches.length} 個)，剩餘 ${historyInfo.remainingMinutes} 分鐘`);
            } else {
                addTimeline(`🆕 顯示新配對結果 (${matches.length} 個)`);
            }
        }

        window.initAuth = async function() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            updateStatus('auth-indicator', 'success');
                            logResult('auth-result', `✅ 登入成功: ${user.email}`);
                            addTimeline(`用戶登入: ${user.email}`);
                        } else {
                            updateStatus('auth-indicator', 'error');
                            logResult('auth-result', '❌ 未登入');
                        }
                        updateButtons();
                    });
                }

                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
            } catch (error) {
                updateStatus('auth-indicator', 'error');
                logResult('auth-result', `❌ 登入失敗: ${error.message}`, true);
            }
        }

        window.logout = async function() {
            try {
                await signOut(auth);
                updateStatus('auth-indicator', 'pending');
                if (testData.timerInterval) {
                    clearInterval(testData.timerInterval);
                    document.getElementById('timer-display').style.display = 'none';
                }
            } catch (error) {
                console.error('登出錯誤:', error);
            }
        }

        window.checkCurrentStatus = async function() {
            if (!currentUser) return;

            try {
                updateStatus('status-indicator', 'pending');
                logResult('status-result', '🔍 檢查當前配對狀態...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg?status_only=true', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('status-indicator', 'success');
                    
                    logResult('status-result', `✅ 狀態檢查完成:
- 配對次數: ${data.matchesUsed}/3
- 剩餘次數: ${data.matchesRemaining}
- 當前結果: ${data.matches ? data.matches.length : 0} 個
- 歷史記錄: ${data.recentMatches ? data.recentMatches.length : 0} 個
- 是歷史記錄: ${data.historyInfo?.isHistorical ? '是' : '否'}
${data.historyInfo?.isHistorical ? `- 剩餘時間: ${data.historyInfo.remainingMinutes} 分鐘` : ''}`);

                    if (data.matches && data.matches.length > 0) {
                        displayMatches(data.matches, data.historyInfo);
                        testData.historyInfo = data.historyInfo;
                    }

                    addTimeline(`狀態檢查: ${data.matches?.length || 0} 個配對結果`);
                } else {
                    updateStatus('status-indicator', 'error');
                    logResult('status-result', `❌ 狀態檢查失敗: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('status-indicator', 'error');
                logResult('status-result', `❌ 狀態檢查錯誤: ${error.message}`, true);
            }
        }

        window.performMatchingTest = async function() {
            if (!currentUser) return;

            try {
                updateStatus('matching-indicator', 'pending');
                logResult('matching-result', '🎯 執行配對測試...');

                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    updateStatus('matching-indicator', 'success');
                    testData.lastMatchTime = new Date();
                    
                    logResult('matching-result', `✅ 配對測試完成:
- 找到配對: ${data.matches ? data.matches.length : 0} 個
- 配對狀態: ${data.matchesUsed}/3
- 歷史信息: ${data.historyInfo ? '有' : '無'}
${data.historyInfo ? `- 剩餘時間: ${data.historyInfo.remainingMinutes} 分鐘` : ''}`);

                    if (data.matches && data.matches.length > 0) {
                        displayMatches(data.matches, data.historyInfo);
                        testData.historyInfo = data.historyInfo;
                        
                        logResult('matching-result', `\n💾 配對結果已保存，1小時內有效
🔄 現在可以測試刷新頁面或時效性功能`);
                        
                        // 啟用時效性測試按鈕
                        document.querySelector('button[onclick="refreshTest()"]').disabled = false;
                        document.querySelector('button[onclick="simulateExpiry()"]').disabled = false;
                    }

                    addTimeline(`配對完成: ${data.matches?.length || 0} 個結果，開始計時`);
                } else {
                    updateStatus('matching-indicator', 'error');
                    logResult('matching-result', `❌ 配對測試失敗: ${result.error}`, true);
                }
            } catch (error) {
                updateStatus('matching-indicator', 'error');
                logResult('matching-result', `❌ 配對測試錯誤: ${error.message}`, true);
            }
        }

        window.refreshTest = async function() {
            addTimeline('🔄 執行刷新測試...');
            logResult('timing-result', '🔄 模擬頁面刷新，重新檢查狀態...');
            await new Promise(resolve => setTimeout(resolve, 500));
            await checkCurrentStatus();
            logResult('timing-result', '✅ 刷新測試完成，檢查歷史記錄是否正確顯示');
        }

        window.simulateExpiry = async function() {
            if (!testData.historyInfo) {
                logResult('timing-result', '⚠️ 沒有歷史記錄可以測試', true);
                return;
            }

            addTimeline('⚠️ 模擬記錄過期測試...');
            logResult('timing-result', '⚠️ 注意：這將清除當前歷史記錄用於測試');
            
            // 等待用戶確認
            if (!confirm('確定要模擬歷史記錄過期嗎？這將清除當前的歷史記錄。')) {
                return;
            }

            try {
                const idToken = await currentUser.getIdToken();
                // 直接調用清理API
                const response = await fetch('/api/debug/matching-sessions', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                logResult('timing-result', '🧹 已觸發過期清理，重新檢查狀態...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                await checkCurrentStatus();
                addTimeline('過期測試完成');
            } catch (error) {
                logResult('timing-result', `❌ 過期測試錯誤: ${error.message}`, true);
            }
        }

        window.clearTimeline = function() {
            document.getElementById('timeline').innerHTML = '<div class="timeline-item">時間軸已清空...</div>';
        }

        // 初始化
        addTimeline('測試工具載入完成');
        updateButtons();
    </script>
</body>
</html>