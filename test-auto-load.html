<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦è‡ªå‹•è¼‰å…¥æ­·å²è¨˜éŒ„</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; background: #f0f8ff; }
        .success { border-color: #4caf50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fff8f0; }
        button { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #005a9e; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #f9f9f9; border: 1px solid #ddd; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .matches-display { border: 2px solid #007acc; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .match-item { background: #f0f8ff; padding: 10px; margin: 5px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è‡ªå‹•è¼‰å…¥æ­·å²è¨˜éŒ„æ¸¬è©¦</h1>
        
        <div class="status" id="auth-status">
            <h3>èªè­‰ç‹€æ…‹</h3>
            <button onclick="initAuth()">åˆå§‹åŒ– & ç™»å…¥</button>
            <div id="auth-info">è«‹å…ˆç™»å…¥</div>
        </div>

        <div class="status" id="auto-load-status">
            <h3>è‡ªå‹•è¼‰å…¥æ¸¬è©¦</h3>
            <button onclick="testAutoLoad()" disabled>æ¸¬è©¦è‡ªå‹•è¼‰å…¥</button>
            <button onclick="window.location.reload()">åˆ·æ–°é é¢æ¸¬è©¦</button>
            <div id="auto-load-info">è«‹å…ˆç™»å…¥</div>
        </div>

        <div class="matches-display" id="matches-section" style="display: none;">
            <h3>ğŸ¯ é…å°çµæœ</h3>
            <div id="matches-content"></div>
        </div>

        <div class="status">
            <h3>ğŸ“‹ è©³ç´°æ—¥èªŒ</h3>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥èªŒ</button>
            <div id="debug-log" class="log">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logDiv = document.getElementById('debug-log');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateButtonState() {
            document.querySelector('button[onclick="testAutoLoad()"]').disabled = !currentUser;
        }

        function displayMatches(matches, title = "é…å°çµæœ") {
            const section = document.getElementById('matches-section');
            const content = document.getElementById('matches-content');
            
            if (matches && matches.length > 0) {
                section.style.display = 'block';
                content.innerHTML = `
                    <h4>${title} (${matches.length} å€‹)</h4>
                    ${matches.map((match, index) => `
                        <div class="match-item">
                            <strong>${index + 1}. ${match.gameTitle}</strong><br>
                            ç©å®¶: ${match.playerName} (${match.playerEmail})<br>
                            é¡å‹: ${match.matchType === 'seeking' ? 'ğŸ” ä½ æƒ³è¦çš„éŠæˆ²' : 'ğŸ å°æ–¹æƒ³è¦çš„éŠæˆ²'}<br>
                            æ™‚é–“: ${match.addedAt || match.matchedAt || 'Unknown'}
                        </div>
                    `).join('')}
                `;
                log(`âœ… é¡¯ç¤º ${matches.length} å€‹é…å°çµæœ`);
            } else {
                section.style.display = 'none';
                log('â„¹ï¸ æ²’æœ‰é…å°çµæœå¯é¡¯ç¤º');
            }
        }

        window.initAuth = async function() {
            const statusDiv = document.getElementById('auth-status');
            const infoDiv = document.getElementById('auth-info');
            
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
                    
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            statusDiv.className = 'status success';
                            infoDiv.textContent = `å·²ç™»å…¥: ${user.email} (é©—è­‰: ${user.emailVerified})`;
                            log(`âœ… ç”¨æˆ¶ç™»å…¥: ${user.email}`);
                            
                            // è‡ªå‹•æ¸¬è©¦è¼‰å…¥
                            setTimeout(() => {
                                log('ğŸš€ è‡ªå‹•åŸ·è¡Œè¼‰å…¥æ¸¬è©¦...');
                                testAutoLoad();
                            }, 1000);
                        } else {
                            statusDiv.className = 'status';
                            infoDiv.textContent = 'æœªç™»å…¥';
                            log('âŒ ç”¨æˆ¶æœªç™»å…¥');
                        }
                        updateButtonState();
                    });
                }
                
                // è§¸ç™¼ç™»å…¥
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
            } catch (error) {
                statusDiv.className = 'status error';
                infoDiv.textContent = `ç™»å…¥å¤±æ•—: ${error.message}`;
                log(`âŒ ç™»å…¥å¤±æ•—: ${error.message}`);
            }
        }

        window.testAutoLoad = async function() {
            const statusDiv = document.getElementById('auto-load-status');
            const infoDiv = document.getElementById('auto-load-info');
            
            if (!currentUser) {
                log('âŒ ç„¡æ³•æ¸¬è©¦ï¼šç”¨æˆ¶æœªç™»å…¥');
                return;
            }

            try {
                statusDiv.className = 'status';
                infoDiv.textContent = 'æ­£åœ¨æª¢æŸ¥é…å°ç‹€æ…‹...';
                log('ğŸ“Š é–‹å§‹ç²å–é…å°ç‹€æ…‹...');

                // æª¢æŸ¥ç”¨æˆ¶é©—è­‰ç‹€æ…‹
                if (!currentUser.emailVerified) {
                    log('âš ï¸ ç”¨æˆ¶é›»å­éƒµä»¶æœªé©—è­‰');
                    infoDiv.textContent = 'è«‹å…ˆé©—è­‰æ‚¨çš„é›»å­éƒµä»¶';
                    statusDiv.className = 'status warning';
                    return;
                }

                const idToken = await currentUser.getIdToken();
                log(`ğŸ« ç²å– ID Token æˆåŠŸï¼Œé•·åº¦: ${idToken.length}`);

                const response = await fetch('/api/matching-pg?status_only=true', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                log(`ğŸ“¥ API éŸ¿æ‡‰ç‹€æ…‹: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    log('ğŸ“‹ API éŸ¿æ‡‰å…§å®¹:');
                    log(JSON.stringify(result, null, 2));

                    const data = result.data;
                    if (data) {
                        log(`ğŸ“Š é…å°ç‹€æ…‹è©³æƒ…:`);
                        log(`- matchesUsed: ${data.matchesUsed}`);
                        log(`- matchesRemaining: ${data.matchesRemaining}`);
                        log(`- rateLimited: ${data.rateLimited}`);
                        log(`- matches æ•¸é‡: ${data.matches ? data.matches.length : 0}`);
                        log(`- recentMatches æ•¸é‡: ${data.recentMatches ? data.recentMatches.length : 0}`);

                        if (data.matches && data.matches.length > 0) {
                            statusDiv.className = 'status success';
                            infoDiv.textContent = `æ‰¾åˆ° ${data.matches.length} å€‹é…å°çµæœï¼`;
                            displayMatches(data.matches, 'ç•¶å‰é…å°çµæœ');
                            log('âœ… æˆåŠŸé¡¯ç¤ºé…å°çµæœ');
                        } else if (data.recentMatches && data.recentMatches.length > 0) {
                            statusDiv.className = 'status warning';
                            infoDiv.textContent = `æ‰¾åˆ° ${data.recentMatches.length} å€‹æ­·å²è¨˜éŒ„ï¼Œä½†æ²’æœ‰åœ¨ matches ä¸­`;
                            displayMatches(data.recentMatches, 'æ­·å²è¨˜éŒ„');
                            log('âš ï¸ æ­·å²è¨˜éŒ„å­˜åœ¨ä½†æœªåœ¨ matches ä¸­é¡¯ç¤º');
                        } else {
                            statusDiv.className = 'status';
                            infoDiv.textContent = 'æ²’æœ‰æ‰¾åˆ°ä»»ä½•é…å°çµæœæˆ–æ­·å²è¨˜éŒ„';
                            log('â„¹ï¸ æ²’æœ‰é…å°çµæœ');
                        }
                    } else {
                        log('âŒ API éŸ¿æ‡‰ä¸­æ²’æœ‰ data æ¬„ä½');
                    }
                } else {
                    const error = await response.json();
                    statusDiv.className = 'status error';
                    infoDiv.textContent = `API éŒ¯èª¤: ${error.error}`;
                    log(`âŒ API éŒ¯èª¤: ${error.error}`);
                }

            } catch (error) {
                statusDiv.className = 'status error';
                infoDiv.textContent = `æ¸¬è©¦å¤±æ•—: ${error.message}`;
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }

        window.clearLog = function() {
            document.getElementById('debug-log').textContent = '';
        }

        // é é¢è¼‰å…¥æ™‚çš„æ—¥èªŒ
        log('ğŸ“± é é¢è¼‰å…¥å®Œæˆ');
    </script>
</body>
</html>