<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試自動載入歷史記錄</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; background: #f0f8ff; }
        .success { border-color: #4caf50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fff8f0; }
        button { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #005a9e; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #f9f9f9; border: 1px solid #ddd; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .matches-display { border: 2px solid #007acc; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .match-item { background: #f0f8ff; padding: 10px; margin: 5px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 自動載入歷史記錄測試</h1>
        
        <div class="status" id="auth-status">
            <h3>認證狀態</h3>
            <button onclick="initAuth()">初始化 & 登入</button>
            <div id="auth-info">請先登入</div>
        </div>

        <div class="status" id="auto-load-status">
            <h3>自動載入測試</h3>
            <button onclick="testAutoLoad()" disabled>測試自動載入</button>
            <button onclick="window.location.reload()">刷新頁面測試</button>
            <div id="auto-load-info">請先登入</div>
        </div>

        <div class="matches-display" id="matches-section" style="display: none;">
            <h3>🎯 配對結果</h3>
            <div id="matches-content"></div>
        </div>

        <div class="status">
            <h3>📋 詳細日誌</h3>
            <button onclick="clearLog()">清空日誌</button>
            <div id="debug-log" class="log">等待操作...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logDiv = document.getElementById('debug-log');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateButtonState() {
            document.querySelector('button[onclick="testAutoLoad()"]').disabled = !currentUser;
        }

        function displayMatches(matches, title = "配對結果") {
            const section = document.getElementById('matches-section');
            const content = document.getElementById('matches-content');
            
            if (matches && matches.length > 0) {
                section.style.display = 'block';
                content.innerHTML = `
                    <h4>${title} (${matches.length} 個)</h4>
                    ${matches.map((match, index) => `
                        <div class="match-item">
                            <strong>${index + 1}. ${match.gameTitle}</strong><br>
                            玩家: ${match.playerName} (${match.playerEmail})<br>
                            類型: ${match.matchType === 'seeking' ? '🔍 你想要的遊戲' : '🎁 對方想要的遊戲'}<br>
                            時間: ${match.addedAt || match.matchedAt || 'Unknown'}
                        </div>
                    `).join('')}
                `;
                log(`✅ 顯示 ${matches.length} 個配對結果`);
            } else {
                section.style.display = 'none';
                log('ℹ️ 沒有配對結果可顯示');
            }
        }

        window.initAuth = async function() {
            const statusDiv = document.getElementById('auth-status');
            const infoDiv = document.getElementById('auth-info');
            
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    log('✅ Firebase 初始化成功');
                    
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            statusDiv.className = 'status success';
                            infoDiv.textContent = `已登入: ${user.email} (驗證: ${user.emailVerified})`;
                            log(`✅ 用戶登入: ${user.email}`);
                            
                            // 自動測試載入
                            setTimeout(() => {
                                log('🚀 自動執行載入測試...');
                                testAutoLoad();
                            }, 1000);
                        } else {
                            statusDiv.className = 'status';
                            infoDiv.textContent = '未登入';
                            log('❌ 用戶未登入');
                        }
                        updateButtonState();
                    });
                }
                
                // 觸發登入
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
            } catch (error) {
                statusDiv.className = 'status error';
                infoDiv.textContent = `登入失敗: ${error.message}`;
                log(`❌ 登入失敗: ${error.message}`);
            }
        }

        window.testAutoLoad = async function() {
            const statusDiv = document.getElementById('auto-load-status');
            const infoDiv = document.getElementById('auto-load-info');
            
            if (!currentUser) {
                log('❌ 無法測試：用戶未登入');
                return;
            }

            try {
                statusDiv.className = 'status';
                infoDiv.textContent = '正在檢查配對狀態...';
                log('📊 開始獲取配對狀態...');

                // 檢查用戶驗證狀態
                if (!currentUser.emailVerified) {
                    log('⚠️ 用戶電子郵件未驗證');
                    infoDiv.textContent = '請先驗證您的電子郵件';
                    statusDiv.className = 'status warning';
                    return;
                }

                const idToken = await currentUser.getIdToken();
                log(`🎫 獲取 ID Token 成功，長度: ${idToken.length}`);

                const response = await fetch('/api/matching-pg?status_only=true', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                log(`📥 API 響應狀態: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    log('📋 API 響應內容:');
                    log(JSON.stringify(result, null, 2));

                    const data = result.data;
                    if (data) {
                        log(`📊 配對狀態詳情:`);
                        log(`- matchesUsed: ${data.matchesUsed}`);
                        log(`- matchesRemaining: ${data.matchesRemaining}`);
                        log(`- rateLimited: ${data.rateLimited}`);
                        log(`- matches 數量: ${data.matches ? data.matches.length : 0}`);
                        log(`- recentMatches 數量: ${data.recentMatches ? data.recentMatches.length : 0}`);

                        if (data.matches && data.matches.length > 0) {
                            statusDiv.className = 'status success';
                            infoDiv.textContent = `找到 ${data.matches.length} 個配對結果！`;
                            displayMatches(data.matches, '當前配對結果');
                            log('✅ 成功顯示配對結果');
                        } else if (data.recentMatches && data.recentMatches.length > 0) {
                            statusDiv.className = 'status warning';
                            infoDiv.textContent = `找到 ${data.recentMatches.length} 個歷史記錄，但沒有在 matches 中`;
                            displayMatches(data.recentMatches, '歷史記錄');
                            log('⚠️ 歷史記錄存在但未在 matches 中顯示');
                        } else {
                            statusDiv.className = 'status';
                            infoDiv.textContent = '沒有找到任何配對結果或歷史記錄';
                            log('ℹ️ 沒有配對結果');
                        }
                    } else {
                        log('❌ API 響應中沒有 data 欄位');
                    }
                } else {
                    const error = await response.json();
                    statusDiv.className = 'status error';
                    infoDiv.textContent = `API 錯誤: ${error.error}`;
                    log(`❌ API 錯誤: ${error.error}`);
                }

            } catch (error) {
                statusDiv.className = 'status error';
                infoDiv.textContent = `測試失敗: ${error.message}`;
                log(`❌ 測試失敗: ${error.message}`);
            }
        }

        window.clearLog = function() {
            document.getElementById('debug-log').textContent = '';
        }

        // 頁面載入時的日誌
        log('📱 頁面載入完成');
    </script>
</body>
</html>