<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整流程測試：頁面載入自動顯示歷史記錄</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: #4caf50; background: #f8fff9; }
        .error { border-color: #f44336; background: #fff8f8; }
        .info { border-color: #2196f3; background: #f0f8ff; }
        .warning { border-color: #ff9800; background: #fff8e1; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .test-btn { background: #4caf50; }
        .test-btn:hover { background: #45a049; }
        .result { margin: 15px 0; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-size: 12px; }
        .step { margin: 10px 0; padding: 15px; background: #f0f0f0; border-left: 5px solid #ddd; }
        .step.completed { border-left-color: #4caf50; background: #f8fff9; }
        .step.failed { border-left-color: #f44336; background: #fff8f8; }
        .step.running { border-left-color: #ff9800; background: #fff8e1; }
        .match-card { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; border-left: 5px solid #2196f3; }
        .match-seeking { border-left-color: #2196f3; }
        .match-offering { border-left-color: #4caf50; }
        .format-check { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .flow-indicator { position: fixed; top: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd; min-width: 200px; }
    </style>
</head>
<body>
    <div class="flow-indicator">
        <h4>🔄 測試進度</h4>
        <div id="flow-status">等待開始...</div>
    </div>

    <div class="container">
        <h1>🧪 完整流程測試</h1>
        <p><strong>目標：</strong>測試用戶進入交換大廳時自動載入並顯示1小時內的配對歷史記錄</p>

        <div class="section info">
            <h3>🔐 Step 0: 登入驗證</h3>
            <button onclick="initAndLogin()">初始化 & 登入</button>
            <div id="auth-status" class="result">等待登入...</div>
        </div>

        <div class="section info">
            <h3>🔧 Step 1: 確保資料庫準備就緒</h3>
            <button onclick="runStep1()" disabled class="test-btn">檢查並遷移資料庫</button>
            <div id="step1-result" class="result">請先登入</div>
            <div class="step" id="progress-step1">步驟 1: 資料庫準備</div>
        </div>

        <div class="section info">
            <h3>🎯 Step 2: 建立配對歷史記錄</h3>
            <button onclick="runStep2()" disabled class="test-btn">執行配對產生歷史</button>
            <div id="step2-result" class="result">請先完成資料庫準備</div>
            <div class="step" id="progress-step2">步驟 2: 產生歷史記錄</div>
        </div>

        <div class="section info">
            <h3>🔄 Step 3: 模擬頁面重新載入</h3>
            <button onclick="runStep3()" disabled class="test-btn">模擬用戶進入交換大廳</button>
            <div id="step3-result" class="result">請先產生歷史記錄</div>
            <div class="step" id="progress-step3">步驟 3: 測試自動載入歷史</div>
        </div>

        <div class="section info">
            <h3>✅ Step 4: 驗證數據格式</h3>
            <button onclick="runStep4()" disabled class="test-btn">詳細格式檢查</button>
            <div id="step4-result" class="result">請先完成頁面載入測試</div>
            <div class="step" id="progress-step4">步驟 4: 驗證格式正確性</div>
        </div>

        <div class="section success" id="final-result" style="display: none;">
            <h3>🎉 測試結果總結</h3>
            <div id="summary-content"></div>
        </div>

        <div class="section info">
            <h3>📋 當前歷史記錄</h3>
            <div id="history-display">尚無歷史記錄</div>
        </div>

        <div class="section warning">
            <h3>🔍 預期數據格式檢查</h3>
            <div class="format-check">
                <h4>每筆配對記錄應包含以下欄位：</h4>
                <pre>{
  "gameId": 21,
  "gameTitle": "薩爾達傳說 王國之淚", 
  "playerId": 28,
  "playerName": "CodePro",
  "playerEmail": "codepro123.st01@gmail.com",
  "matchType": "seeking", // 或 "offering"
  "matchedAt": "2025-08-30T04:40:05.487Z"
}</pre>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;
        let testProgress = {
            step1: false,
            step2: false, 
            step3: false,
            step4: false
        };
        let historicalMatches = [];

        function formatTime() {
            return new Date().toLocaleTimeString('zh-TW');
        }

        function updateFlowStatus(status) {
            document.getElementById('flow-status').textContent = status;
        }

        function updateStep(stepId, status) {
            const step = document.getElementById(`progress-${stepId}`);
            step.className = status === 'completed' ? 'step completed' : 
                           status === 'failed' ? 'step failed' : 
                           status === 'running' ? 'step running' : 'step';
        }

        function updateButtons() {
            document.querySelector('button[onclick="runStep1()"]').disabled = !currentUser;
            document.querySelector('button[onclick="runStep2()"]').disabled = !currentUser || !testProgress.step1;
            document.querySelector('button[onclick="runStep3()"]').disabled = !currentUser || !testProgress.step2;
            document.querySelector('button[onclick="runStep4()"]').disabled = !currentUser || !testProgress.step3;
        }

        function validateMatchFormat(matches) {
            if (!Array.isArray(matches)) return { valid: false, errors: ['Data is not an array'] };
            
            const requiredFields = ['gameId', 'gameTitle', 'playerId', 'playerName', 'playerEmail', 'matchType'];
            const errors = [];
            
            matches.forEach((match, index) => {
                requiredFields.forEach(field => {
                    if (!(field in match) || match[field] === null || match[field] === undefined) {
                        errors.push(`Record ${index}: Missing field "${field}"`);
                    }
                });
                
                if (match.matchType && !['seeking', 'offering'].includes(match.matchType)) {
                    errors.push(`Record ${index}: Invalid matchType "${match.matchType}"`);
                }
            });
            
            return { valid: errors.length === 0, errors, totalRecords: matches.length };
        }

        function displayMatches(matches, containerId, title) {
            const container = document.getElementById(containerId);
            if (!matches || matches.length === 0) {
                container.innerHTML = '<p>沒有歷史記錄</p>';
                return;
            }

            let html = `<h4>${title} (${matches.length} 筆記錄)</h4>`;
            matches.forEach((match, index) => {
                const cardClass = match.matchType === 'seeking' ? 'match-card match-seeking' : 'match-card match-offering';
                html += `
                    <div class="${cardClass}">
                        <div><strong>🎮 遊戲:</strong> ${match.gameTitle} (ID: ${match.gameId})</div>
                        <div><strong>👤 玩家:</strong> ${match.playerName} (ID: ${match.playerId})</div>
                        <div><strong>📧 Email:</strong> ${match.playerEmail}</div>
                        <div><strong>🔄 類型:</strong> ${match.matchType === 'seeking' ? '🔍 我想要的遊戲有人持有' : '🎁 我持有的遊戲有人想要'}</div>
                        <div><strong>⏰ 配對時間:</strong> ${new Date(match.matchedAt || match.addedAt).toLocaleString('zh-TW')}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.initAndLogin = async function() {
            const statusDiv = document.getElementById('auth-status');
            
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            statusDiv.textContent = `✅ 已登入 [${formatTime()}]
用戶: ${user.email}
UID: ${user.uid}`;
                            statusDiv.parentElement.className = 'section success';
                            updateFlowStatus('用戶已登入，準備測試');
                        } else {
                            statusDiv.textContent = '❌ 未登入';
                            statusDiv.parentElement.className = 'section error';
                            updateFlowStatus('等待用戶登入');
                        }
                        updateButtons();
                    });
                }

                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
            } catch (error) {
                statusDiv.textContent = `❌ 登入失敗: ${error.message}`;
                statusDiv.parentElement.className = 'section error';
                updateFlowStatus('登入失敗');
            }
        }

        window.runStep1 = async function() {
            if (!currentUser) return;

            const resultDiv = document.getElementById('step1-result');
            updateStep('step1', 'running');
            updateFlowStatus('執行資料庫遷移...');
            
            try {
                resultDiv.textContent = '🔧 檢查並執行資料庫遷移...';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/db/migrate-history', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    testProgress.step1 = true;
                    updateStep('step1', 'completed');
                    updateButtons();
                    updateFlowStatus('資料庫準備完成');
                    
                    const data = result.data;
                    resultDiv.textContent = `✅ 資料庫遷移完成 [${formatTime()}]

🔄 執行的遷移:
${data.migrations.map(m => `- ${m}`).join('\n')}

🎯 關鍵欄位檢查:
- last_match_games: ${data.target_columns.last_match_games ? '✅ 存在' : '❌ 缺少'}
- last_match_at: ${data.target_columns.last_match_at ? '✅ 存在' : '❌ 缺少'}`;
                    
                    resultDiv.parentElement.className = 'section success';

                } else {
                    updateStep('step1', 'failed');
                    updateFlowStatus('資料庫遷移失敗');
                    resultDiv.textContent = `❌ 資料庫遷移失敗: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                updateStep('step1', 'failed');
                updateFlowStatus('資料庫遷移錯誤');
                resultDiv.textContent = `❌ 遷移錯誤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.runStep2 = async function() {
            if (!currentUser || !testProgress.step1) return;

            const resultDiv = document.getElementById('step2-result');
            updateStep('step2', 'running');
            updateFlowStatus('產生配對歷史記錄...');
            
            try {
                resultDiv.textContent = '🎯 執行配對以產生歷史記錄...';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    testProgress.step2 = true;
                    updateStep('step2', 'completed');
                    updateButtons();
                    updateFlowStatus('歷史記錄已產生');
                    
                    const data = result.data;
                    historicalMatches = data.matches || [];
                    
                    resultDiv.textContent = `✅ 配對完成，歷史記錄已產生 [${formatTime()}]

🎯 配對結果:
- 總計: ${data.matches.length} 個配對
- 尋求類型: ${data.summary.seeking}
- 提供類型: ${data.summary.offering}

📝 歷史記錄儲存:
- 儲存時間: NOW()
- 有效期限: 60分鐘
- 儲存位置: user_matching_sessions.last_match_games

配對使用情況:
- 已使用: ${data.matchesUsed}/3
- 剩餘: ${data.matchesRemaining}`;
                    
                    resultDiv.parentElement.className = 'section success';
                    
                    if (historicalMatches.length > 0) {
                        displayMatches(historicalMatches, 'history-display', '剛產生的配對記錄');
                    }

                } else {
                    updateStep('step2', 'failed');
                    updateFlowStatus('配對執行失敗');
                    resultDiv.textContent = `❌ 配對失敗: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                updateStep('step2', 'failed');
                updateFlowStatus('配對執行錯誤');
                resultDiv.textContent = `❌ 配對錯誤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.runStep3 = async function() {
            if (!currentUser || !testProgress.step2) return;

            const resultDiv = document.getElementById('step3-result');
            updateStep('step3', 'running');
            updateFlowStatus('測試頁面自動載入...');
            
            try {
                resultDiv.textContent = '🔄 模擬用戶進入交換大廳頁面...';
                
                // 等待2秒模擬頁面切換
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const idToken = await currentUser.getIdToken();
                // 模擬頁面載入時的 status_only 請求
                const response = await fetch('/api/matching-pg?status_only=true', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const loadedMatches = data.matches || [];
                    const hasHistory = data.historyInfo && data.historyInfo.isHistorical;
                    
                    if (hasHistory && loadedMatches.length > 0) {
                        testProgress.step3 = true;
                        updateStep('step3', 'completed');
                        updateButtons();
                        updateFlowStatus('自動載入歷史成功');
                        
                        historicalMatches = loadedMatches; // 更新為載入的歷史記錄
                        
                        resultDiv.textContent = `✅ 頁面自動載入歷史記錄成功 [${formatTime()}]

🔄 載入狀態:
- 自動載入: ${loadedMatches.length} 個配對記錄
- 歷史記錄: ✅ 是
- 剩餘時間: ${data.historyInfo.remainingMinutes} 分鐘
- 過期時間: ${data.historyInfo.expireTime}

📊 配對狀態:
- 配對餘額: ${data.matchesRemaining}/3
- 是否受限: ${data.rateLimited ? '是' : '否'}

🎮 配對分類:
- 尋求類型: ${loadedMatches.filter(m => m.matchType === 'seeking').length}
- 提供類型: ${loadedMatches.filter(m => m.matchType === 'offering').length}

✨ 模擬成功：用戶進入交換大廳時能自動看到1小時內的配對歷史！`;
                        
                        resultDiv.parentElement.className = 'section success';
                        displayMatches(loadedMatches, 'history-display', '🔄 自動載入的歷史記錄');
                        
                    } else {
                        updateStep('step3', 'failed');
                        updateFlowStatus('自動載入歷史失敗');
                        resultDiv.textContent = `❌ 自動載入測試失敗

問題分析:
- 載入配對: ${loadedMatches.length} 個
- 是歷史記錄: ${hasHistory ? '是' : '否'}
- 配對餘額: ${data.matchesRemaining}
- 限制狀態: ${data.rateLimited}

可能原因:
1. 歷史記錄已過期 (超過60分鐘)
2. 歷史記錄未正確儲存到資料庫
3. 查詢邏輯有問題`;
                        resultDiv.parentElement.className = 'section error';
                    }

                } else {
                    updateStep('step3', 'failed');
                    updateFlowStatus('載入請求失敗');
                    resultDiv.textContent = `❌ 頁面載入請求失敗: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                updateStep('step3', 'failed');
                updateFlowStatus('載入測試錯誤');
                resultDiv.textContent = `❌ 載入測試錯誤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.runStep4 = async function() {
            if (!currentUser || !testProgress.step3) return;

            const resultDiv = document.getElementById('step4-result');
            updateStep('step4', 'running');
            updateFlowStatus('驗證數據格式...');
            
            try {
                resultDiv.textContent = '✅ 驗證歷史記錄數據格式...';
                
                const validation = validateMatchFormat(historicalMatches);
                
                if (validation.valid) {
                    testProgress.step4 = true;
                    updateStep('step4', 'completed');
                    updateFlowStatus('所有測試完成！');
                    
                    resultDiv.textContent = `✅ 數據格式驗證通過 [${formatTime()}]

🎯 格式檢查結果:
- 總記錄數: ${validation.totalRecords}
- 格式驗證: ✅ 通過
- 必要欄位: ✅ 完整

📋 每筆記錄包含:
${historicalMatches.map((match, index) => `
記錄 ${index + 1}:
  - gameId: ${match.gameId}
  - gameTitle: "${match.gameTitle}"
  - playerId: ${match.playerId}
  - playerName: "${match.playerName}"
  - playerEmail: "${match.playerEmail}"
  - matchType: "${match.matchType}"
  - matchedAt: "${match.matchedAt || match.addedAt}"`).join('\n')}

🎉 測試結果: 完全符合預期格式！`;
                    
                    resultDiv.parentElement.className = 'section success';
                    
                    // 顯示最終測試總結
                    document.getElementById('final-result').style.display = 'block';
                    document.getElementById('summary-content').textContent = `
✅ 完整流程測試成功！

測試結果總結:
1. ✅ 資料庫欄位 (last_match_games, last_match_at) 正確建立
2. ✅ 配對執行能正確儲存歷史記錄到資料庫
3. ✅ 用戶進入交換大廳時自動載入1小時內的歷史記錄
4. ✅ 歷史記錄格式完全符合預期規範

系統運作狀況:
- 歷史記錄載入: 自動化
- 數據格式: 標準化
- 有效期管理: 60分鐘自動清除
- 用戶體驗: 無縫銜接

🎯 核心功能確認:
每當用戶進入交換大廳頁面，系統會自動判斷 user_matching_sessions 
中的配對歷史記錄，如果未超過1小時，就透過 last_match_games 內的
JSON 數據顯示歷史配對結果，格式完全符合規範。`;

                } else {
                    updateStep('step4', 'failed');
                    updateFlowStatus('格式驗證失敗');
                    resultDiv.textContent = `❌ 數據格式驗證失敗

發現問題:
- 總記錄數: ${validation.totalRecords}
- 格式錯誤數: ${validation.errors.length}

錯誤詳情:
${validation.errors.join('\n')}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                updateStep('step4', 'failed');
                updateFlowStatus('格式驗證錯誤');
                resultDiv.textContent = `❌ 格式驗證錯誤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        // 初始化
        updateButtons();
        updateFlowStatus('等待開始測試');
    </script>
</body>
</html>