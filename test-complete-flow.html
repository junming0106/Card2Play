<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´æµç¨‹æ¸¬è©¦ï¼šé é¢è¼‰å…¥è‡ªå‹•é¡¯ç¤ºæ­·å²è¨˜éŒ„</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: #4caf50; background: #f8fff9; }
        .error { border-color: #f44336; background: #fff8f8; }
        .info { border-color: #2196f3; background: #f0f8ff; }
        .warning { border-color: #ff9800; background: #fff8e1; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .test-btn { background: #4caf50; }
        .test-btn:hover { background: #45a049; }
        .result { margin: 15px 0; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-size: 12px; }
        .step { margin: 10px 0; padding: 15px; background: #f0f0f0; border-left: 5px solid #ddd; }
        .step.completed { border-left-color: #4caf50; background: #f8fff9; }
        .step.failed { border-left-color: #f44336; background: #fff8f8; }
        .step.running { border-left-color: #ff9800; background: #fff8e1; }
        .match-card { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; border-left: 5px solid #2196f3; }
        .match-seeking { border-left-color: #2196f3; }
        .match-offering { border-left-color: #4caf50; }
        .format-check { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .flow-indicator { position: fixed; top: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd; min-width: 200px; }
    </style>
</head>
<body>
    <div class="flow-indicator">
        <h4>ğŸ”„ æ¸¬è©¦é€²åº¦</h4>
        <div id="flow-status">ç­‰å¾…é–‹å§‹...</div>
    </div>

    <div class="container">
        <h1>ğŸ§ª å®Œæ•´æµç¨‹æ¸¬è©¦</h1>
        <p><strong>ç›®æ¨™ï¼š</strong>æ¸¬è©¦ç”¨æˆ¶é€²å…¥äº¤æ›å¤§å»³æ™‚è‡ªå‹•è¼‰å…¥ä¸¦é¡¯ç¤º1å°æ™‚å…§çš„é…å°æ­·å²è¨˜éŒ„</p>

        <div class="section info">
            <h3>ğŸ” Step 0: ç™»å…¥é©—è­‰</h3>
            <button onclick="initAndLogin()">åˆå§‹åŒ– & ç™»å…¥</button>
            <div id="auth-status" class="result">ç­‰å¾…ç™»å…¥...</div>
        </div>

        <div class="section info">
            <h3>ğŸ”§ Step 1: ç¢ºä¿è³‡æ–™åº«æº–å‚™å°±ç·’</h3>
            <button onclick="runStep1()" disabled class="test-btn">æª¢æŸ¥ä¸¦é·ç§»è³‡æ–™åº«</button>
            <div id="step1-result" class="result">è«‹å…ˆç™»å…¥</div>
            <div class="step" id="progress-step1">æ­¥é©Ÿ 1: è³‡æ–™åº«æº–å‚™</div>
        </div>

        <div class="section info">
            <h3>ğŸ¯ Step 2: å»ºç«‹é…å°æ­·å²è¨˜éŒ„</h3>
            <button onclick="runStep2()" disabled class="test-btn">åŸ·è¡Œé…å°ç”¢ç”Ÿæ­·å²</button>
            <div id="step2-result" class="result">è«‹å…ˆå®Œæˆè³‡æ–™åº«æº–å‚™</div>
            <div class="step" id="progress-step2">æ­¥é©Ÿ 2: ç”¢ç”Ÿæ­·å²è¨˜éŒ„</div>
        </div>

        <div class="section info">
            <h3>ğŸ”„ Step 3: æ¨¡æ“¬é é¢é‡æ–°è¼‰å…¥</h3>
            <button onclick="runStep3()" disabled class="test-btn">æ¨¡æ“¬ç”¨æˆ¶é€²å…¥äº¤æ›å¤§å»³</button>
            <div id="step3-result" class="result">è«‹å…ˆç”¢ç”Ÿæ­·å²è¨˜éŒ„</div>
            <div class="step" id="progress-step3">æ­¥é©Ÿ 3: æ¸¬è©¦è‡ªå‹•è¼‰å…¥æ­·å²</div>
        </div>

        <div class="section info">
            <h3>âœ… Step 4: é©—è­‰æ•¸æ“šæ ¼å¼</h3>
            <button onclick="runStep4()" disabled class="test-btn">è©³ç´°æ ¼å¼æª¢æŸ¥</button>
            <div id="step4-result" class="result">è«‹å…ˆå®Œæˆé é¢è¼‰å…¥æ¸¬è©¦</div>
            <div class="step" id="progress-step4">æ­¥é©Ÿ 4: é©—è­‰æ ¼å¼æ­£ç¢ºæ€§</div>
        </div>

        <div class="section success" id="final-result" style="display: none;">
            <h3>ğŸ‰ æ¸¬è©¦çµæœç¸½çµ</h3>
            <div id="summary-content"></div>
        </div>

        <div class="section info">
            <h3>ğŸ“‹ ç•¶å‰æ­·å²è¨˜éŒ„</h3>
            <div id="history-display">å°šç„¡æ­·å²è¨˜éŒ„</div>
        </div>

        <div class="section warning">
            <h3>ğŸ” é æœŸæ•¸æ“šæ ¼å¼æª¢æŸ¥</h3>
            <div class="format-check">
                <h4>æ¯ç­†é…å°è¨˜éŒ„æ‡‰åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š</h4>
                <pre>{
  "gameId": 21,
  "gameTitle": "è–©çˆ¾é”å‚³èªª ç‹åœ‹ä¹‹æ·š", 
  "playerId": 28,
  "playerName": "CodePro",
  "playerEmail": "codepro123.st01@gmail.com",
  "matchType": "seeking", // æˆ– "offering"
  "matchedAt": "2025-08-30T04:40:05.487Z"
}</pre>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBi9z-KWH0DcZ_qZVVfg1pPWGSZ7i5LR8Y",
            authDomain: "card2play-2f3a5.firebaseapp.com",
            projectId: "card2play-2f3a5",
            storageBucket: "card2play-2f3a5.appspot.com",
            messagingSenderId: "588167816001",
            appId: "1:588167816001:web:c2e64b35f9de4a5fa0c4f1"
        };

        let app, auth, currentUser = null;
        let testProgress = {
            step1: false,
            step2: false, 
            step3: false,
            step4: false
        };
        let historicalMatches = [];

        function formatTime() {
            return new Date().toLocaleTimeString('zh-TW');
        }

        function updateFlowStatus(status) {
            document.getElementById('flow-status').textContent = status;
        }

        function updateStep(stepId, status) {
            const step = document.getElementById(`progress-${stepId}`);
            step.className = status === 'completed' ? 'step completed' : 
                           status === 'failed' ? 'step failed' : 
                           status === 'running' ? 'step running' : 'step';
        }

        function updateButtons() {
            document.querySelector('button[onclick="runStep1()"]').disabled = !currentUser;
            document.querySelector('button[onclick="runStep2()"]').disabled = !currentUser || !testProgress.step1;
            document.querySelector('button[onclick="runStep3()"]').disabled = !currentUser || !testProgress.step2;
            document.querySelector('button[onclick="runStep4()"]').disabled = !currentUser || !testProgress.step3;
        }

        function validateMatchFormat(matches) {
            if (!Array.isArray(matches)) return { valid: false, errors: ['Data is not an array'] };
            
            const requiredFields = ['gameId', 'gameTitle', 'playerId', 'playerName', 'playerEmail', 'matchType'];
            const errors = [];
            
            matches.forEach((match, index) => {
                requiredFields.forEach(field => {
                    if (!(field in match) || match[field] === null || match[field] === undefined) {
                        errors.push(`Record ${index}: Missing field "${field}"`);
                    }
                });
                
                if (match.matchType && !['seeking', 'offering'].includes(match.matchType)) {
                    errors.push(`Record ${index}: Invalid matchType "${match.matchType}"`);
                }
            });
            
            return { valid: errors.length === 0, errors, totalRecords: matches.length };
        }

        function displayMatches(matches, containerId, title) {
            const container = document.getElementById(containerId);
            if (!matches || matches.length === 0) {
                container.innerHTML = '<p>æ²’æœ‰æ­·å²è¨˜éŒ„</p>';
                return;
            }

            let html = `<h4>${title} (${matches.length} ç­†è¨˜éŒ„)</h4>`;
            matches.forEach((match, index) => {
                const cardClass = match.matchType === 'seeking' ? 'match-card match-seeking' : 'match-card match-offering';
                html += `
                    <div class="${cardClass}">
                        <div><strong>ğŸ® éŠæˆ²:</strong> ${match.gameTitle} (ID: ${match.gameId})</div>
                        <div><strong>ğŸ‘¤ ç©å®¶:</strong> ${match.playerName} (ID: ${match.playerId})</div>
                        <div><strong>ğŸ“§ Email:</strong> ${match.playerEmail}</div>
                        <div><strong>ğŸ”„ é¡å‹:</strong> ${match.matchType === 'seeking' ? 'ğŸ” æˆ‘æƒ³è¦çš„éŠæˆ²æœ‰äººæŒæœ‰' : 'ğŸ æˆ‘æŒæœ‰çš„éŠæˆ²æœ‰äººæƒ³è¦'}</div>
                        <div><strong>â° é…å°æ™‚é–“:</strong> ${new Date(match.matchedAt || match.addedAt).toLocaleString('zh-TW')}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.initAndLogin = async function() {
            const statusDiv = document.getElementById('auth-status');
            
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            statusDiv.textContent = `âœ… å·²ç™»å…¥ [${formatTime()}]
ç”¨æˆ¶: ${user.email}
UID: ${user.uid}`;
                            statusDiv.parentElement.className = 'section success';
                            updateFlowStatus('ç”¨æˆ¶å·²ç™»å…¥ï¼Œæº–å‚™æ¸¬è©¦');
                        } else {
                            statusDiv.textContent = 'âŒ æœªç™»å…¥';
                            statusDiv.parentElement.className = 'section error';
                            updateFlowStatus('ç­‰å¾…ç”¨æˆ¶ç™»å…¥');
                        }
                        updateButtons();
                    });
                }

                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
            } catch (error) {
                statusDiv.textContent = `âŒ ç™»å…¥å¤±æ•—: ${error.message}`;
                statusDiv.parentElement.className = 'section error';
                updateFlowStatus('ç™»å…¥å¤±æ•—');
            }
        }

        window.runStep1 = async function() {
            if (!currentUser) return;

            const resultDiv = document.getElementById('step1-result');
            updateStep('step1', 'running');
            updateFlowStatus('åŸ·è¡Œè³‡æ–™åº«é·ç§»...');
            
            try {
                resultDiv.textContent = 'ğŸ”§ æª¢æŸ¥ä¸¦åŸ·è¡Œè³‡æ–™åº«é·ç§»...';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/db/migrate-history', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    testProgress.step1 = true;
                    updateStep('step1', 'completed');
                    updateButtons();
                    updateFlowStatus('è³‡æ–™åº«æº–å‚™å®Œæˆ');
                    
                    const data = result.data;
                    resultDiv.textContent = `âœ… è³‡æ–™åº«é·ç§»å®Œæˆ [${formatTime()}]

ğŸ”„ åŸ·è¡Œçš„é·ç§»:
${data.migrations.map(m => `- ${m}`).join('\n')}

ğŸ¯ é—œéµæ¬„ä½æª¢æŸ¥:
- last_match_games: ${data.target_columns.last_match_games ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå°‘'}
- last_match_at: ${data.target_columns.last_match_at ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå°‘'}`;
                    
                    resultDiv.parentElement.className = 'section success';

                } else {
                    updateStep('step1', 'failed');
                    updateFlowStatus('è³‡æ–™åº«é·ç§»å¤±æ•—');
                    resultDiv.textContent = `âŒ è³‡æ–™åº«é·ç§»å¤±æ•—: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                updateStep('step1', 'failed');
                updateFlowStatus('è³‡æ–™åº«é·ç§»éŒ¯èª¤');
                resultDiv.textContent = `âŒ é·ç§»éŒ¯èª¤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.runStep2 = async function() {
            if (!currentUser || !testProgress.step1) return;

            const resultDiv = document.getElementById('step2-result');
            updateStep('step2', 'running');
            updateFlowStatus('ç”¢ç”Ÿé…å°æ­·å²è¨˜éŒ„...');
            
            try {
                resultDiv.textContent = 'ğŸ¯ åŸ·è¡Œé…å°ä»¥ç”¢ç”Ÿæ­·å²è¨˜éŒ„...';
                
                const idToken = await currentUser.getIdToken();
                const response = await fetch('/api/matching-pg', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    testProgress.step2 = true;
                    updateStep('step2', 'completed');
                    updateButtons();
                    updateFlowStatus('æ­·å²è¨˜éŒ„å·²ç”¢ç”Ÿ');
                    
                    const data = result.data;
                    historicalMatches = data.matches || [];
                    
                    resultDiv.textContent = `âœ… é…å°å®Œæˆï¼Œæ­·å²è¨˜éŒ„å·²ç”¢ç”Ÿ [${formatTime()}]

ğŸ¯ é…å°çµæœ:
- ç¸½è¨ˆ: ${data.matches.length} å€‹é…å°
- å°‹æ±‚é¡å‹: ${data.summary.seeking}
- æä¾›é¡å‹: ${data.summary.offering}

ğŸ“ æ­·å²è¨˜éŒ„å„²å­˜:
- å„²å­˜æ™‚é–“: NOW()
- æœ‰æ•ˆæœŸé™: 60åˆ†é˜
- å„²å­˜ä½ç½®: user_matching_sessions.last_match_games

é…å°ä½¿ç”¨æƒ…æ³:
- å·²ä½¿ç”¨: ${data.matchesUsed}/3
- å‰©é¤˜: ${data.matchesRemaining}`;
                    
                    resultDiv.parentElement.className = 'section success';
                    
                    if (historicalMatches.length > 0) {
                        displayMatches(historicalMatches, 'history-display', 'å‰›ç”¢ç”Ÿçš„é…å°è¨˜éŒ„');
                    }

                } else {
                    updateStep('step2', 'failed');
                    updateFlowStatus('é…å°åŸ·è¡Œå¤±æ•—');
                    resultDiv.textContent = `âŒ é…å°å¤±æ•—: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                updateStep('step2', 'failed');
                updateFlowStatus('é…å°åŸ·è¡ŒéŒ¯èª¤');
                resultDiv.textContent = `âŒ é…å°éŒ¯èª¤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.runStep3 = async function() {
            if (!currentUser || !testProgress.step2) return;

            const resultDiv = document.getElementById('step3-result');
            updateStep('step3', 'running');
            updateFlowStatus('æ¸¬è©¦é é¢è‡ªå‹•è¼‰å…¥...');
            
            try {
                resultDiv.textContent = 'ğŸ”„ æ¨¡æ“¬ç”¨æˆ¶é€²å…¥äº¤æ›å¤§å»³é é¢...';
                
                // ç­‰å¾…2ç§’æ¨¡æ“¬é é¢åˆ‡æ›
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const idToken = await currentUser.getIdToken();
                // æ¨¡æ“¬é é¢è¼‰å…¥æ™‚çš„ status_only è«‹æ±‚
                const response = await fetch('/api/matching-pg?status_only=true', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const loadedMatches = data.matches || [];
                    const hasHistory = data.historyInfo && data.historyInfo.isHistorical;
                    
                    if (hasHistory && loadedMatches.length > 0) {
                        testProgress.step3 = true;
                        updateStep('step3', 'completed');
                        updateButtons();
                        updateFlowStatus('è‡ªå‹•è¼‰å…¥æ­·å²æˆåŠŸ');
                        
                        historicalMatches = loadedMatches; // æ›´æ–°ç‚ºè¼‰å…¥çš„æ­·å²è¨˜éŒ„
                        
                        resultDiv.textContent = `âœ… é é¢è‡ªå‹•è¼‰å…¥æ­·å²è¨˜éŒ„æˆåŠŸ [${formatTime()}]

ğŸ”„ è¼‰å…¥ç‹€æ…‹:
- è‡ªå‹•è¼‰å…¥: ${loadedMatches.length} å€‹é…å°è¨˜éŒ„
- æ­·å²è¨˜éŒ„: âœ… æ˜¯
- å‰©é¤˜æ™‚é–“: ${data.historyInfo.remainingMinutes} åˆ†é˜
- éæœŸæ™‚é–“: ${data.historyInfo.expireTime}

ğŸ“Š é…å°ç‹€æ…‹:
- é…å°é¤˜é¡: ${data.matchesRemaining}/3
- æ˜¯å¦å—é™: ${data.rateLimited ? 'æ˜¯' : 'å¦'}

ğŸ® é…å°åˆ†é¡:
- å°‹æ±‚é¡å‹: ${loadedMatches.filter(m => m.matchType === 'seeking').length}
- æä¾›é¡å‹: ${loadedMatches.filter(m => m.matchType === 'offering').length}

âœ¨ æ¨¡æ“¬æˆåŠŸï¼šç”¨æˆ¶é€²å…¥äº¤æ›å¤§å»³æ™‚èƒ½è‡ªå‹•çœ‹åˆ°1å°æ™‚å…§çš„é…å°æ­·å²ï¼`;
                        
                        resultDiv.parentElement.className = 'section success';
                        displayMatches(loadedMatches, 'history-display', 'ğŸ”„ è‡ªå‹•è¼‰å…¥çš„æ­·å²è¨˜éŒ„');
                        
                    } else {
                        updateStep('step3', 'failed');
                        updateFlowStatus('è‡ªå‹•è¼‰å…¥æ­·å²å¤±æ•—');
                        resultDiv.textContent = `âŒ è‡ªå‹•è¼‰å…¥æ¸¬è©¦å¤±æ•—

å•é¡Œåˆ†æ:
- è¼‰å…¥é…å°: ${loadedMatches.length} å€‹
- æ˜¯æ­·å²è¨˜éŒ„: ${hasHistory ? 'æ˜¯' : 'å¦'}
- é…å°é¤˜é¡: ${data.matchesRemaining}
- é™åˆ¶ç‹€æ…‹: ${data.rateLimited}

å¯èƒ½åŸå› :
1. æ­·å²è¨˜éŒ„å·²éæœŸ (è¶…é60åˆ†é˜)
2. æ­·å²è¨˜éŒ„æœªæ­£ç¢ºå„²å­˜åˆ°è³‡æ–™åº«
3. æŸ¥è©¢é‚è¼¯æœ‰å•é¡Œ`;
                        resultDiv.parentElement.className = 'section error';
                    }

                } else {
                    updateStep('step3', 'failed');
                    updateFlowStatus('è¼‰å…¥è«‹æ±‚å¤±æ•—');
                    resultDiv.textContent = `âŒ é é¢è¼‰å…¥è«‹æ±‚å¤±æ•—: ${result.error}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                updateStep('step3', 'failed');
                updateFlowStatus('è¼‰å…¥æ¸¬è©¦éŒ¯èª¤');
                resultDiv.textContent = `âŒ è¼‰å…¥æ¸¬è©¦éŒ¯èª¤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        window.runStep4 = async function() {
            if (!currentUser || !testProgress.step3) return;

            const resultDiv = document.getElementById('step4-result');
            updateStep('step4', 'running');
            updateFlowStatus('é©—è­‰æ•¸æ“šæ ¼å¼...');
            
            try {
                resultDiv.textContent = 'âœ… é©—è­‰æ­·å²è¨˜éŒ„æ•¸æ“šæ ¼å¼...';
                
                const validation = validateMatchFormat(historicalMatches);
                
                if (validation.valid) {
                    testProgress.step4 = true;
                    updateStep('step4', 'completed');
                    updateFlowStatus('æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼');
                    
                    resultDiv.textContent = `âœ… æ•¸æ“šæ ¼å¼é©—è­‰é€šé [${formatTime()}]

ğŸ¯ æ ¼å¼æª¢æŸ¥çµæœ:
- ç¸½è¨˜éŒ„æ•¸: ${validation.totalRecords}
- æ ¼å¼é©—è­‰: âœ… é€šé
- å¿…è¦æ¬„ä½: âœ… å®Œæ•´

ğŸ“‹ æ¯ç­†è¨˜éŒ„åŒ…å«:
${historicalMatches.map((match, index) => `
è¨˜éŒ„ ${index + 1}:
  - gameId: ${match.gameId}
  - gameTitle: "${match.gameTitle}"
  - playerId: ${match.playerId}
  - playerName: "${match.playerName}"
  - playerEmail: "${match.playerEmail}"
  - matchType: "${match.matchType}"
  - matchedAt: "${match.matchedAt || match.addedAt}"`).join('\n')}

ğŸ‰ æ¸¬è©¦çµæœ: å®Œå…¨ç¬¦åˆé æœŸæ ¼å¼ï¼`;
                    
                    resultDiv.parentElement.className = 'section success';
                    
                    // é¡¯ç¤ºæœ€çµ‚æ¸¬è©¦ç¸½çµ
                    document.getElementById('final-result').style.display = 'block';
                    document.getElementById('summary-content').textContent = `
âœ… å®Œæ•´æµç¨‹æ¸¬è©¦æˆåŠŸï¼

æ¸¬è©¦çµæœç¸½çµ:
1. âœ… è³‡æ–™åº«æ¬„ä½ (last_match_games, last_match_at) æ­£ç¢ºå»ºç«‹
2. âœ… é…å°åŸ·è¡Œèƒ½æ­£ç¢ºå„²å­˜æ­·å²è¨˜éŒ„åˆ°è³‡æ–™åº«
3. âœ… ç”¨æˆ¶é€²å…¥äº¤æ›å¤§å»³æ™‚è‡ªå‹•è¼‰å…¥1å°æ™‚å…§çš„æ­·å²è¨˜éŒ„
4. âœ… æ­·å²è¨˜éŒ„æ ¼å¼å®Œå…¨ç¬¦åˆé æœŸè¦ç¯„

ç³»çµ±é‹ä½œç‹€æ³:
- æ­·å²è¨˜éŒ„è¼‰å…¥: è‡ªå‹•åŒ–
- æ•¸æ“šæ ¼å¼: æ¨™æº–åŒ–
- æœ‰æ•ˆæœŸç®¡ç†: 60åˆ†é˜è‡ªå‹•æ¸…é™¤
- ç”¨æˆ¶é«”é©—: ç„¡ç¸«éŠœæ¥

ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ç¢ºèª:
æ¯ç•¶ç”¨æˆ¶é€²å…¥äº¤æ›å¤§å»³é é¢ï¼Œç³»çµ±æœƒè‡ªå‹•åˆ¤æ–· user_matching_sessions 
ä¸­çš„é…å°æ­·å²è¨˜éŒ„ï¼Œå¦‚æœæœªè¶…é1å°æ™‚ï¼Œå°±é€é last_match_games å…§çš„
JSON æ•¸æ“šé¡¯ç¤ºæ­·å²é…å°çµæœï¼Œæ ¼å¼å®Œå…¨ç¬¦åˆè¦ç¯„ã€‚`;

                } else {
                    updateStep('step4', 'failed');
                    updateFlowStatus('æ ¼å¼é©—è­‰å¤±æ•—');
                    resultDiv.textContent = `âŒ æ•¸æ“šæ ¼å¼é©—è­‰å¤±æ•—

ç™¼ç¾å•é¡Œ:
- ç¸½è¨˜éŒ„æ•¸: ${validation.totalRecords}
- æ ¼å¼éŒ¯èª¤æ•¸: ${validation.errors.length}

éŒ¯èª¤è©³æƒ…:
${validation.errors.join('\n')}`;
                    resultDiv.parentElement.className = 'section error';
                }
            } catch (error) {
                updateStep('step4', 'failed');
                updateFlowStatus('æ ¼å¼é©—è­‰éŒ¯èª¤');
                resultDiv.textContent = `âŒ æ ¼å¼é©—è­‰éŒ¯èª¤: ${error.message}`;
                resultDiv.parentElement.className = 'section error';
            }
        }

        // åˆå§‹åŒ–
        updateButtons();
        updateFlowStatus('ç­‰å¾…é–‹å§‹æ¸¬è©¦');
    </script>
</body>
</html>