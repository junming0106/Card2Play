<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料庫查詢測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .query-result { 
            background: #f5f5f5; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>資料庫查詢測試</h1>
        
        <div>
            <button onclick="queryMatchingSessions()">查詢 user_matching_sessions</button>
            <button onclick="queryMatchSessions()">查詢 user_match_sessions</button>
            <button onclick="queryUsersWithSessions()">查詢有配對記錄的用戶</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function showResult(title, data, isError = false) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `query-result ${isError ? 'error' : 'success'}`;
            div.innerHTML = `<h3>${title}</h3>${JSON.stringify(data, null, 2)}`;
            results.appendChild(div);
        }

        async function queryMatchingSessions() {
            try {
                const response = await fetch('/api/debug/matching-sessions');
                const data = await response.json();
                showResult('User Matching Sessions', data);
            } catch (error) {
                showResult('錯誤', error.message, true);
            }
        }

        async function queryMatchSessions() {
            try {
                // 建立一個簡單的查詢 API
                const response = await fetch('/api/debug/query-db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `
                            SELECT 
                                ms.id, 
                                ms.wanter_user_id, 
                                ms.holder_user_id, 
                                ms.game_id,
                                ms.match_date,
                                ms.status,
                                g.title as game_title,
                                wu.name as wanter_name,
                                hu.name as holder_name
                            FROM user_match_sessions ms
                            JOIN games g ON ms.game_id = g.id
                            JOIN users wu ON ms.wanter_user_id = wu.id
                            JOIN users hu ON ms.holder_user_id = hu.id
                            ORDER BY ms.match_date DESC
                            LIMIT 20
                        `
                    })
                });
                const data = await response.json();
                showResult('User Match Sessions', data);
            } catch (error) {
                showResult('錯誤', error.message, true);
            }
        }

        async function queryUsersWithSessions() {
            try {
                const response = await fetch('/api/debug/query-db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `
                            SELECT 
                                ums.id,
                                ums.user_id,
                                u.name,
                                u.email,
                                ums.session_start,
                                ums.matches_used,
                                ums.last_match_at,
                                CASE 
                                    WHEN ums.last_match_games IS NOT NULL THEN 'HAS_DATA'
                                    ELSE 'NO_DATA'
                                END as has_last_match_games,
                                LENGTH(ums.last_match_games::text) as json_length
                            FROM user_matching_sessions ums
                            JOIN users u ON ums.user_id = u.id
                            ORDER BY ums.last_match_at DESC NULLS LAST
                            LIMIT 20
                        `
                    })
                });
                const data = await response.json();
                showResult('Users with Matching Sessions', data);
            } catch (error) {
                showResult('錯誤', error.message, true);
            }
        }
    </script>
</body>
</html>