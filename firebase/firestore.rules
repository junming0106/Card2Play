rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 用戶資料規則 - 只允許用戶存取自己的資料
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 遊戲資料規則 - 所有人可讀，只有管理員可寫
    match /games/{gameId} {
      allow read: if true;
      allow write: if request.auth != null && 
                   request.auth.token.admin == true;
    }
    
    // 個人收藏規則 - 只有擁有者可存取
    match /collections/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 收藏中的遊戲子集合
      match /games/{gameId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // 交易規則 - 交易雙方可讀寫
    match /trades/{tradeId} {
      allow read: if request.auth != null && 
                  (request.auth.uid == resource.data.sellerId || 
                   request.auth.uid == resource.data.buyerId);
      allow create: if request.auth != null && 
                    request.auth.uid == request.resource.data.sellerId;
      allow update: if request.auth != null && 
                    (request.auth.uid == resource.data.sellerId || 
                     request.auth.uid == resource.data.buyerId) &&
                    request.resource.data.keys().hasAll(['sellerId', 'buyerId', 'gameId']);
    }
    
    // 評價規則 - 只有認證用戶可以建立評價
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null && 
                    request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && 
                            request.auth.uid == resource.data.userId;
    }
    
    // 推薦規則 - 只有擁有者可存取
    match /recommendations/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}